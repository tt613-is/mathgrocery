# Math Grocery - 数学杂货店游戏

## 🎮 项目简介

一个帮助练习心算的网页小游戏。玩家扮演杂货店老板，完成真实的收银流程：接待顾客、拿商品、收钱找零。

**核心玩法（v0.3.0 完整收银模拟）：**
- 顾客提出需求（"我要买 🍎x2 🍩x1"）
- 玩家从货架拿商品给顾客
- 顾客支付金额
- 玩家从钱箱选择币额组合找零
- 系统判断对错并显示顾客反馈
- 连续服务多位顾客

## 🚀 快速开始

直接用浏览器打开 `index.html` 即可开始游戏。

## ✨ 当前功能（v0.4.0 等式记录器版本）

**核心功能：**
- [x] 顾客队列系统（连续服务多位顾客）
- [x] 顾客订单生成（2-3种商品，随机数量）
- [x] 拿商品给顾客（点击货架 → 添加到顾客购物袋）
- [x] 等式记录器（输入等式或直接结果）
- [x] 对错判断和表情反馈（😊/😢）
- [x] 连续服务记录（成功次数/分数）
- [x] 货架配置化系统（JSON配置 + 可视化编辑器）

**等式记录器特色：**
- [x] 支持完整等式输入（如：10-7.5=2.5）
- [x] 支持直接结果输入（如：2.5）
- [x] 手绘风格倒三角按钮布局
- [x] 绿色显示屏 + 红色送出按钮
- [x] 退格删除功能

**配置管理系统：**
- [x] game-config.json 配置文件
- [x] config.html 可视化配置页面
- [x] 外部配置加载 + 内嵌默认配置备份
- [x] 详细使用文档（CONFIG_GUIDE.md + JSON_GUIDE.md）

## 🛠 技术栈

- **纯 HTML/CSS/JavaScript** - 无框架依赖
- **单文件架构** - 所有代码在 index.html 中
- **响应式设计** - 适配移动端和桌面端

## 📝 开发决策记录

### 2025-01-02 - 项目初始化

**为什么选择单文件架构？**
- 便于部署：双击即可运行，无需服务器
- 降低复杂度：MVP阶段无需构建工具
- 易于分享：单个HTML文件即可传播

**为什么使用小数价格？**
- 更贴近真实购物场景
- 增加计算难度和趣味性
- 使用toFixed(2)处理浮点数精度问题

**商品定价策略：**
- 价格范围：$0.5-$56.3
- 甜甜圈有A/B/C三种型号，价格不同
- 支持小数点后最多2位
- 顾客支付金额 = 总价 + 随机(1-5)美元，保证有找零

### 2025-01-02 - 价格系统更新

**更新商品库：**
- 从6种商品扩展到11种商品
- 新增鸡腿商品
- 甜甜圈分为A/B/C三种型号，增加多样性

**支持小数价格：**
- 棒棒糖 $0.5（MVP阶段暂不支持数量优惠）
- 甜甜圈A/B/C分别为 $2/$2.5/$2.7
- 薯片 $1.2
- 肉/鱼/鸡腿 $56.3（高价商品增加难度）

**浮点数精度处理：**
- 所有价格计算使用 `toFixed(2)` 保留两位小数
- 比较答案时也使用 `toFixed(2)` 避免精度问题
- 确保显示和计算的一致性

### 2025-01-02 - 游戏玩法重构 (v0.2.0)

**为什么重新设计游戏玩法？**
- 参考手绘设计图，增强玩家互动性
- 让玩家主动选择商品，而非被动接受订单
- 更接近真实购物和收银场景

**游戏流程：**
1. 阶段1：玩家浏览货架，点击选择商品
2. 阶段2：管理购物车（可添加/移除）
3. 阶段3：确认订单，系统生成顾客支付金额
4. 阶段4：计算并输入找零
5. 阶段5：查看结果反馈

**UI/UX优化：**
- 网格布局展示所有商品（响应式）
- 悬停效果提示可点击
- 购物车实时显示已选商品

**技术实现：**
- 游戏状态管理（phase: selecting/checkout/result）
- 购物车数据结构
- 分阶段UI显示/隐藏控制

### 2025-01-03 - 完整收银模拟重构 (v0.3.0)

**为什么再次重构？**
- 参考新的手绘设计图，打造完整收银流程
- 取消购物车概念，改为"顾客下单 → 老板拿货"的真实场景
- 从"输入数字"改为"选择实物币额"，更具沉浸感
- 引入新加坡货币体系，更符合本地化需求

**新的游戏流程（4阶段）：**
1. **接收订单**：顾客出现并说出需求（"I want to buy: 🍎x2 🍩x1"）
2. **拿商品给顾客**：玩家点击货架商品，商品变灰不可再点，凑齐后自动进入下一阶段
3. **收钱找零**：显示总价和顾客支付金额，玩家从钱箱点击币额组合找零（支持toggle选中/取消）
4. **结果反馈**：对错判断，顾客离开，下一位顾客进入

**UI布局设计：**
- **上方25vh**：顾客区域
  - 顾客头像居中下移到底部边缘（80px大小）
  - 对话框在头像右上方，气泡指向头像
  - 购物袋在右上角固定位置
- **下方75vh**：
  - 左侧：货架（3层垂直布局，参考sketches手绘图）
  - 中间：钱箱区域（展示所有币额和数量）+ 操作区（当前订单、已选金额、确认按钮）

**重要游戏机制改进（2025-01-03）：**
1. **商品实例化系统**：
   - 每个商品图标有唯一ID（item_0, item_1...）
   - 顾客要2个牛奶，必须点击2个不同的牛奶图标
   - 点击后商品变灰（opacity: 0.3）且不可再点
   - 每轮开始时重新渲染货架，重置所有状态

2. **订单智能生成**：
   - 统计货架上每种商品的实际数量
   - 顾客需求的数量不会超过货架库存
   - 例如：货架有3个苹果，顾客最多要3个

3. **币额选择优化**：
   - 点击币额按钮，黄色高亮边框（#ffc107）
   - 再次点击取消选择（toggle功能）
   - 实时显示："Selected ×2 (8 left)"
   - "Reset"按钮一键清空所有选择

### 2025-01-03 - 动画与视觉优化 (v0.3.0+)

**为什么添加动画？**
- 提升用户体验，让游戏更有趣、更有沉浸感
- 通过视觉反馈帮助玩家理解游戏状态变化
- 让操作更流畅，减少生硬感

**动画效果列表：**
1. **顾客入场动画** (`customerEnter`): 顾客头像从上方滑入并淡入 (0.5s ease-out)
2. **对话框弹出** (`dialogBounce`): 对话框缩放弹跳出现 (0.5s cubic-bezier)
3. **购物袋摇晃** (`bagShake`): 添加商品时袋子左右摇晃+放大 (0.5s ease)
4. **商品拾取动画** (`pickAnimation`): 商品被点击时旋转+缩放+渐变灰色 (0.4s ease)
5. **币额选择脉冲** (`coinPulse`): 选中币额时短暂放大+光晕增强 (0.3s ease)
6. **货架淡入** (`shelfFadeIn`): 货架区域从下方滑入并淡入 (0.5s ease-out)
7. **收银台滑入** (`slideInFromTop`): 钱箱面板从上方滑入 (0.5s ease-out)
8. **反馈覆盖层淡入** (`fadeIn`): 结果屏幕背景渐变出现 (0.3s ease)
9. **反馈框弹跳** (`feedbackBounce`): 结果框旋转缩放弹入 (0.5s cubic-bezier)
10. **表情弹出** (`emojiPop`): 😊/😡表情旋转弹出 (0.6s ease, 延迟0.3s)
11. **按钮涟漪效果**: 鼠标悬停时从中心扩散的圆形涟漪 (::before伪元素)

**技术实现：**
- **CSS Keyframes**: 定义10+个关键帧动画
- **Transform动画**: 使用translate/scale/rotate实现流畅效果
- **Timing Functions**:
  - `ease-out`: 入场动画（快速开始，缓慢结束）
  - `cubic-bezier(0.68, -0.55, 0.265, 1.55)`: 弹跳效果（超出后回弹）
  - `ease`: 平滑过渡
- **Animation Delay**: 错开动画时间（如对话框延迟0.2s，表情延迟0.3s）
- **Animation Fill Mode**: `both` 保持动画结束状态
- **JavaScript触发**:
  - `updateCustomerBag()` 触发袋子shake动画
  - 使用 `classList.add/remove` + `offsetWidth` 强制重新触发动画

**性能优化：**
- 优先使用transform/opacity（GPU加速）
- 避免触发layout的属性（width/height/top/left）
- 动画时长控制在0.3s-0.6s，保持流畅不拖沓
- 使用will-change暗示浏览器优化（未来可添加）

### 2025-01-04 - 等式记录器重构 (v0.4.0)

**为什么改为等式记录器？**
- 参考手绘设计图，采用创意的倒三角按钮布局
- 从实物币额选择改为数字输入，降低复杂度
- 支持心算练习：既可以写完整等式，也可以直接写答案
- 更适合iPad和Mac端使用

**等式记录器设计：**
- **显示屏**：绿色渐变背景，显示玩家输入的等式或数字
- **送出按钮**：红色⬆️按钮，位于显示屏右侧
- **数字键盘**：倒三角形布局（1234 → 567 → 89 → 0🔙）
- **操作符**：+ - × ÷ = . 六个按钮

**按钮布局（倒三角形）：**
```
提示：Enter equation or result (e.g., 10-7.5=2.5 or 2.5)

┌──────────────────────┬──────┐
│  [绿色显示屏]         │ ⬆️  │
└──────────────────────┴──────┘

     1    2    3    4
       5    6    7
         8    9
           0    🔙

   +  -  ×  ÷  =  .
```

**两种输入模式：**
1. **完整等式模式**：`10-7.5=2.5`
   - 玩家可以写出完整的心算过程
   - 系统提取等号右边的值进行验证

2. **直接结果模式**：`2.5`
   - 玩家直接输入答案
   - 系统将整个输入作为找零金额验证

**验证逻辑：**
```javascript
// 支持两种输入方式
extractChangeAmount() {
    if (包含等号) {
        return 等号右边的数字;
    } else {
        return 整个输入转为数字;
    }
}
```

**视觉设计：**
- 蓝色渐变背景（#1e3c72 → #2a5298）
- 绿色显示屏（#4caf50 → #66bb6a）
- 黑色圆形数字按钮（70x70px）
- 红色送出和退格按钮（醒目标识）
- 紫色操作符按钮

**用户体验优化：**
- 退格删除：🔙按钮删除最后一个字符
- 实时显示：所有输入立即显示在屏幕上
- 清晰反馈：😊/😢表情 + 详细结果信息
- 流畅流程：验证后自动进入下一个顾客

### 2025-01-04 - 配置管理系统 (v0.4.0)

**为什么需要配置系统？**
- 货架位置、商品数量需要频繁调整
- 希望支持图形界面和JSON两种配置方式
- 配置与代码分离，便于维护和版本控制

**实现方案：B+A混合方案**

**方案B：图形界面配置（config.html）**
- 3列布局：货架列表 | 编辑表单 | 实时预览
- 可视化编辑所有货架属性
- 支持导出/导入JSON文件
- 保存到LocalStorage
- 详细文档：CONFIG_GUIDE.md

**方案A：JSON直接编辑（game-config.json）**
- 纯文本配置文件
- 适合批量修改和版本控制
- 完整的字段说明和示例
- 详细文档：JSON_GUIDE.md

**配置加载机制：**
1. 优先从外部 `game-config.json` 加载
2. 加载失败自动使用内嵌默认配置
3. 控制台输出加载状态

**新加坡货币系统：**
- 硬币：$0.05、$0.10、$0.20、$0.50、$1
- 纸币：$2、$5、$10、$50
- 钱箱初始库存：每种币额若干张（例如各10-20张）

**商品定价调整：**
- 价格精确到 $0.05（配合新加坡最小币额）
- 降低高价商品价格（$56.3 → $15）避免过大金额
- 示例：棒棒糖 $0.50、苹果 $1.00、甜甜圈A/B/C $2/$2.50/$3、肉类 $15

**核心机制：**
1. **顾客队列**：随机生成2-3种商品订单，连续服务多位顾客
2. **拿货机制**：点击商品 → 检查是否在订单中 → 标记为已选（变灰）→ 添加到顾客购物袋
3. **钱币管理**：每种币额有数量限制，点击选择累加金额，可撤销
4. **找零验证**：检查金额是否正确（可选：最少张数挑战）

**技术实现：**
- 游戏状态管理（phase: order_received/picking_items/making_change/result）
- 商品实例ID系统：`itemIdCounter`自增生成唯一ID
- 钱币库存数据结构：`cashRegister = { '0.05': 10, '0.10': 10, ... }`
- 订单匹配逻辑（拿货时检查是否在订单中，检查数量）
- 币额选择逻辑（toggle选中/取消，累加、撤销、验证）
- 顾客队列系统（当前顾客、待服务顾客）
- CSS状态类：`.picked`（已选商品变灰）、`.selected`（币额高亮）

**架构设计（方案C：混合配置化架构）：**
采用三层分离设计，确保货架区域易于修改和扩展：

1. **配置层（数据驱动）**：
   - `SHELF_CONFIG` 定义所有货架区域的布局、位置、商品
   - 每个区域包含：id、名称、类型、位置、尺寸、布局方式、商品列表
   - 修改货架只需修改配置对象，无需改动渲染代码

2. **渲染层（逻辑复用）**：
   - `initShelfAreas()` - 初始化所有货架区域
   - `renderShelfArea(config)` - 根据配置渲染单个区域
   - `renderProducts(products, layout)` - 根据布局类型渲染商品
   - 使用事件委托统一处理商品点击
   - `createProductItem()` - 为每个商品实例分配唯一ID

3. **样式层（视觉呈现）**：
   - 预定义样式类：`.shelf-area-tower`、`.shelf-area-grid`、`.shelf-area-freezer`
   - 配置中提供内联样式（位置、尺寸）
   - 响应式单位（vh/vw/%）确保不同屏幕适配

**优势**：
- 易维护：调整货架位置/大小/商品只需改配置
- 可扩展：新增区域只需添加配置项
- 可复用：商品可出现在多个区域（但每个实例独立）
- 易测试：区域独立渲染，互不干扰
- 真实模拟：每个商品图标对应一个实物，贴近真实收银场景

## 🎯 代码结构（v0.3.0）

### 核心数据

#### 商品库（对象形式，便于查询）
```javascript
const PRODUCTS = {
  lollipop: { name: "棒棒糖", emoji: "🍭", price: 0.50 },
  apple: { name: "苹果", emoji: "🍎", price: 1.00 },
  donut_a: { name: "甜甜圈A", emoji: "🍩", price: 2.00 },
  donut_b: { name: "甜甜圈B", emoji: "🍩", price: 2.50 },
  donut_c: { name: "甜甜圈C", emoji: "🍩", price: 3.00 },
  chips: { name: "薯片", emoji: "🍟", price: 1.20 },
  orange: { name: "橙子", emoji: "🍊", price: 3.00 },
  milk: { name: "牛奶", emoji: "🥛", price: 1.50 },
  meat: { name: "肉", emoji: "🥩", price: 15.00 },
  fish: { name: "鱼", emoji: "🐟", price: 15.00 },
  chicken: { name: "鸡腿", emoji: "🍗", price: 15.00 }
}
```

#### 货架区域配置（核心配置，易于修改）
```javascript
const SHELF_CONFIG = [
  {
    id: 'donut-tower',
    name: '甜甜圈塔',
    type: 'tower',
    position: { left: '0', top: '8vh' },  // 从顾客区域1/3处开始
    size: { width: '120px', height: '62vh' },
    layout: 'vertical',  // 垂直堆叠
    products: ['donut_c', 'donut_b', 'donut_a'],
    style: 'shelf-area-tower'
  },
  {
    id: 'snack-corner',
    name: '零食角',
    type: 'grid',
    position: { left: '0', bottom: '0' },
    size: { width: '200px', height: '30vh' },
    layout: 'grid',  // 网格布局
    gridConfig: { rows: 2, cols: 3 },
    products: ['lollipop', 'lollipop', 'chips', 'chips', 'chips', 'chips'],
    style: 'shelf-area-grid'
  },
  {
    id: 'fruit-stand',
    name: '水果展示台',
    type: 'shelves',
    position: { left: '250px', top: '35vh' },
    size: { width: '180px', height: '35vh' },
    layout: 'rows',  // 分层展示
    products: [
      { row: 'top', items: ['orange', 'orange'] },
      { row: 'middle', items: ['apple', 'apple', 'apple'] },
      { row: 'bottom', items: ['milk'] }
    ],
    style: 'shelf-area-shelves'
  },
  {
    id: 'seafood-freezer',
    name: '海鲜冰柜',
    type: 'freezer',
    position: { right: '20px', top: '30vh' },
    size: { width: '220px', height: '20vh' },
    layout: 'scattered',  // 散列布局
    products: ['fish', 'fish', 'fish'],
    label: '$50 each',
    style: 'shelf-area-freezer'
  },
  {
    id: 'meat-freezer',
    name: '肉类冰柜',
    type: 'freezer',
    position: { right: '20px', top: '55vh' },
    size: { width: '220px', height: '35vh' },
    layout: 'mixed',
    products: ['meat', 'chicken', 'chicken', 'chicken', 'chicken'],
    style: 'shelf-area-freezer'
  }
]
```

#### 钱币系统（新加坡货币）
```javascript
const cashRegister = {
  '0.05': 10,  '0.10': 10,  '0.20': 10,  '0.50': 10,
  '1': 20,     '2': 10,     '5': 10,     '10': 10,  '50': 5
}

// 游戏状态管理
gameState = {
  phase: 'order_received',  // order_received, picking_items, making_change, result
  currentCustomer: {
    order: [                // 顾客订单
      { product: {...}, quantity: 2 }
    ],
    bag: [],                // 已给的商品
    totalPrice: 0,          // 总价
    paid: 0,                // 支付金额
    correctChange: 0        // 正确找零
  },
  selectedCoins: [],        // 玩家选择的币额
  selectedAmount: 0,        // 已选金额
  score: 0                  // 连续成功次数
}
```

### 核心函数

#### 货架渲染系统
- `initShelfAreas()` - 初始化所有货架区域（遍历SHELF_CONFIG）
- `renderShelfArea(config)` - 根据配置渲染单个货架区域
- `renderProducts(products, layout)` - 根据布局类型渲染商品
- `handleProductClick(event)` - 事件委托处理商品点击

#### 游戏流程
- `generateCustomer()` - 生成随机顾客订单
- `startOrder()` - 开始接单，显示顾客需求
- `pickItem(productId)` - 拿商品给顾客（检查订单匹配）
- `checkOrderComplete()` - 检查是否凑齐订单
- `startMakingChange()` - 进入找零阶段

#### 找零系统
- `selectCoin(denomination)` - 选择币额（检查库存）
- `deselectCoin(index)` - 撤销币额选择
- `confirmChange()` - 确认找零
- `checkChange()` - 验证找零是否正确

#### 顾客管理
- `nextCustomer()` - 服务下一位顾客
- `updateCustomerBag()` - 更新顾客购物袋显示
- `showCustomerReaction(isCorrect)` - 显示顾客反馈表情

## 🗺 迭代计划

### v0.3.0 - 完整收银模拟 (当前开发)
- [ ] 顾客队列系统
- [ ] 4阶段游戏流程（接单→拿货→找零→反馈）
- [ ] 货架左侧3层垂直布局
- [ ] 新加坡币系统（9种币额）
- [ ] 实物币额选择找零
- [ ] 拿货动画（商品飞到顾客购物袋）
- [ ] 钱币管理（库存显示）
- [ ] 连续服务记录（成功次数）

### v0.4.0 - 难度系统
- [ ] 简单模式：整数价格，顾客给整钱，一键找零
- [ ] 普通模式：小数价格（精确到0.10），2-3种商品
- [ ] 困难模式：精确到0.05，3-4种商品，最少张数挑战
- [ ] 专家模式：钱币库存有限，需要策略性找零

### v0.5.0 - 游戏性增强
- [ ] 倒计时功能（增加紧张感）
- [ ] 连击奖励（连续答对加分）
- [ ] 钱币库存动态补充（顾客付款时获得币额）
- [ ] 特殊顾客事件（急性子顾客、大额订单）

### v0.6.0 - 用户体验
- [ ] 本地存储最高分和最长连击
- [ ] 动画效果优化（商品飞行、币额闪烁）
- [ ] 音效反馈（收钱、找零、顾客反应）
- [ ] 成就系统（服务100位顾客、零失误等）

### 未来想法
- [ ] 多人对战模式（比谁服务顾客更快）
- [ ] 每日挑战（限定商品、特殊规则）
- [ ] 商品优惠系统（棒棒糖买2送1）

## 🤖 AI 协作提示

**给 Claude 的上下文：**
- 这是一个单人开发的教育小游戏项目
- 所有代码在 `index.html` 中
- 文档策略：claude.md 替代 README（同时服务于用户和AI）
- Git 工作流：功能完成后统一提交

**开发原则：**
- MVP 优先，功能极简
- 代码清晰，注释完整
- 每次提交都更新文档

**当前待办事项：**
查看 todo list 了解当前任务进度

## 📚 参考资源

- [JavaScript 浮点数精度问题](https://0.30000000000000004.com/)
- [Keep a Changelog](https://keepachangelog.com/)

## 📄 许可

个人学习项目，欢迎参考和使用。
