<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Êï∞Â≠¶ÊùÇË¥ßÂ∫ó v0.3.0 - Math Grocery</title>
    <style>
        /* ==================== ÂÖ®Â±ÄÊ†∑Âºè ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow: hidden;
        }

        /* ==================== Ê∏∏ÊàèÂÆπÂô® ==================== */
        .game-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: white;
        }

        /* ==================== È°æÂÆ¢Âå∫Âüü (‰∏äÊñπ 25vh) ==================== */
        .customer-area {
            height: 25vh;
            background: linear-gradient(180deg, #e3f2fd 0%, #bbdefb 100%);
            border-bottom: 3px solid #1976d2;
            padding: 15px 30px;
            position: relative;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 10px;
        }

        .customer-avatar {
            font-size: 80px;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.2));
            margin-bottom: 0;
        }

        .customer-dialog {
            position: absolute;
            right: 80px;
            top: 20px;
            max-width: 400px;
            background: white;
            border-radius: 12px;
            padding: 12px 18px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            text-align: center;
        }

        .customer-dialog::before {
            content: '';
            position: absolute;
            bottom: -15px;
            left: 30px;
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 15px solid white;
        }

        .dialog-text {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }

        .customer-order {
            font-size: 18px;
            font-weight: bold;
            color: #1976d2;
        }

        .customer-bag {
            position: absolute;
            right: 30px;
            top: 50%;
            transform: translateY(-50%);
            min-width: 150px;
            background: #fff3cd;
            border-radius: 10px;
            padding: 10px;
            border: 2px dashed #ffa726;
        }

        .bag-title {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .bag-items {
            font-size: 24px;
            min-height: 30px;
        }

        .payment-info {
            text-align: center;
            margin-top: 10px;
        }

        .payment-amount {
            font-size: 18px;
            font-weight: bold;
            color: #d32f2f;
        }

        /* ==================== Ë¥ßÊû∂+Êìç‰ΩúÂå∫Âüü (‰∏ãÊñπ 75vh) ==================== */
        .main-area {
            height: 75vh;
            display: flex;
            position: relative;
            background: #f5f5f5;
        }

        /* ==================== Ë¥ßÊû∂ÂÆπÂô® ==================== */
        .shelf-container {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        /* Ë¥ßÊû∂Âå∫ÂüüÂü∫Á°ÄÊ†∑Âºè */
        .shelf-area {
            position: absolute;
            border: 2px solid #999;
            border-radius: 8px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* Ë¥ßÊû∂Á±ªÂûãÔºöÂûÇÁõ¥Â°îÂºè */
        .shelf-area-tower {
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            background: linear-gradient(180deg, #fff9c4 0%, #fff59d 100%);
        }

        /* Ë¥ßÊû∂Á±ªÂûãÔºöÁΩëÊ†º */
        .shelf-area-grid {
            display: grid;
            gap: 8px;
            background: linear-gradient(135deg, #fce4ec 0%, #f8bbd0 100%);
        }

        /* Ë¥ßÊû∂Á±ªÂûãÔºöÂàÜÂ±ÇÂ±ïÁ§∫ */
        .shelf-area-shelves {
            display: flex;
            flex-direction: column;
            justify-content: space-evenly;
            background: linear-gradient(180deg, #e8f5e9 0%, #c8e6c9 100%);
        }

        .shelf-row {
            display: flex;
            gap: 10px;
            justify-content: center;
            padding: 5px 0;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .shelf-row:last-child {
            border-bottom: none;
        }

        /* Ë¥ßÊû∂Á±ªÂûãÔºöÂÜ∞Êüú */
        .shelf-area-freezer {
            background: linear-gradient(135deg, #e1f5fe 0%, #b3e5fc 100%);
            border: 3px solid #0277bd;
            display: flex;
            flex-wrap: wrap;
            align-content: flex-start;
            gap: 8px;
            padding: 15px;
        }

        .freezer-label {
            position: absolute;
            top: -12px;
            right: 10px;
            background: #0277bd;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        /* ÂïÜÂìÅÂç°Áâá */
        .product-item {
            cursor: pointer;
            text-align: center;
            padding: 8px;
            background: white;
            border-radius: 8px;
            border: 2px solid #ddd;
            transition: all 0.2s;
            user-select: none;
        }

        .product-item:hover:not(.picked) {
            transform: scale(1.05);
            border-color: #667eea;
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
        }

        .product-item:active:not(.picked) {
            transform: scale(0.98);
        }

        .product-item.picked {
            opacity: 0.3;
            cursor: not-allowed;
            border-color: #ccc;
        }

        .product-emoji {
            font-size: 32px;
            margin-bottom: 4px;
        }

        .product-name {
            font-size: 12px;
            color: #666;
        }

        .product-price {
            font-size: 14px;
            font-weight: bold;
            color: #d32f2f;
            margin-top: 2px;
        }

        /* ==================== Èí±ÁÆ±+Êìç‰ΩúÂå∫Âüü ==================== */
        .cashier-area {
            position: absolute;
            left: 50%;
            top: 10%;
            transform: translateX(-50%);
            width: 500px;
            max-width: 90vw;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.2);
            z-index: 10;
        }

        .cashier-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        /* Èí±ÁÆ± */
        .cash-register {
            background: #f5f5f5;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .cash-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 10px;
        }

        .coin-btn {
            padding: 10px 5px;
            background: #fff;
            border: 2px solid #999;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .coin-btn:hover:not(:disabled) {
            background: #e3f2fd;
            border-color: #1976d2;
            transform: translateY(-2px);
        }

        .coin-btn:active:not(:disabled) {
            transform: translateY(0);
        }

        .coin-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .coin-btn.selected {
            background: #fff9c4;
            border: 3px solid #ffc107;
            box-shadow: 0 0 10px rgba(255, 193, 7, 0.5);
        }

        .coin-value {
            font-size: 14px;
            font-weight: bold;
            color: #333;
        }

        .coin-stock {
            font-size: 11px;
            color: #666;
            margin-top: 2px;
        }

        /* ÂΩìÂâçËÆ¢Âçï‰ø°ÊÅØ */
        .order-info {
            background: #fff3cd;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .info-row:last-child {
            margin-bottom: 0;
            padding-top: 8px;
            border-top: 2px solid #ffa726;
            font-size: 16px;
            font-weight: bold;
        }

        .info-label {
            color: #666;
        }

        .info-value {
            color: #d32f2f;
            font-weight: bold;
        }

        /* Â∑≤ÈÄâÈáëÈ¢ùÊòæÁ§∫ */
        .selected-amount {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            color: #1976d2;
            margin: 15px 0;
            padding: 10px;
            background: #e3f2fd;
            border-radius: 8px;
        }

        /* ÊåâÈíÆÁªÑ */
        .btn-group {
            display: flex;
            gap: 10px;
        }

        .btn {
            flex: 1;
            padding: 12px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #5568d3;
        }

        .btn-secondary {
            background: #ff7675;
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #d63031;
        }

        .btn-success {
            background: #00b894;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #00a383;
        }

        /* ==================== ÂèçÈ¶àÂå∫Âüü ==================== */
        .feedback-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .feedback-overlay.show {
            display: flex;
        }

        .feedback-box {
            background: white;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            max-width: 400px;
        }

        .feedback-emoji {
            font-size: 80px;
            margin-bottom: 20px;
        }

        .feedback-text {
            font-size: 20px;
            color: #333;
            margin-bottom: 30px;
            white-space: pre-line;
        }

        /* ==================== ÈöêËóèÂÖÉÁ¥† ==================== */
        .hidden {
            display: none !important;
        }

        /* ==================== ÂìçÂ∫îÂºèËÆæËÆ° ==================== */
        @media (max-width: 768px) {
            .customer-area {
                padding: 10px 15px;
            }

            .customer-avatar {
                font-size: 60px;
            }

            .customer-bag {
                right: 15px;
                min-width: 120px;
            }

            .dialog-text {
                font-size: 14px;
            }

            .customer-order {
                font-size: 16px;
            }

            .cashier-area {
                width: 95vw;
                padding: 15px;
            }

            .cash-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .product-emoji {
                font-size: 24px;
            }

            .product-name {
                font-size: 10px;
            }

            .product-price {
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- ==================== È°æÂÆ¢Âå∫Âüü ==================== -->
        <div class="customer-area">
            <div class="customer-avatar" id="customerAvatar">üë§</div>

            <div class="customer-dialog">
                <div class="dialog-text" id="dialogText">Welcome to Math Grocery!</div>
                <div class="customer-order" id="customerOrder"></div>
                <div class="payment-info hidden" id="paymentInfo">
                    <span class="payment-amount" id="paymentAmount"></span>
                </div>
            </div>

            <!-- Ë¥≠Áâ©Ë¢ãÊîæÂú®Âè≥‰∏äËßí -->
            <div class="customer-bag">
                <div class="bag-title">Customer's Bag</div>
                <div class="bag-items" id="bagItems">-</div>
            </div>
        </div>

        <!-- ==================== Ë¥ßÊû∂+Êìç‰ΩúÂå∫Âüü ==================== -->
        <div class="main-area">
            <!-- Ë¥ßÊû∂ÂÆπÂô®ÔºàÂä®ÊÄÅÁîüÊàêÔºâ -->
            <div class="shelf-container" id="shelfContainer"></div>

            <!-- Èí±ÁÆ±+Êìç‰ΩúÂå∫Âüü -->
            <div class="cashier-area hidden" id="cashierArea">
                <div class="cashier-title">üí∞ Cash Register</div>

                <!-- ÂΩìÂâçËÆ¢Âçï‰ø°ÊÅØ -->
                <div class="order-info" id="orderInfo">
                    <div class="info-row">
                        <span class="info-label">Order:</span>
                        <span class="info-value" id="orderSummary">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Total:</span>
                        <span class="info-value" id="totalPrice">$0.00</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Customer Paid:</span>
                        <span class="info-value" id="customerPaid">$0.00</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Change Due:</span>
                        <span class="info-value" id="correctChange">$0.00</span>
                    </div>
                </div>

                <!-- Èí±ÁÆ± -->
                <div class="cash-register">
                    <div class="cash-grid" id="cashGrid"></div>
                </div>

                <!-- Â∑≤ÈÄâÈáëÈ¢ù -->
                <div class="selected-amount">
                    Selected: <span id="selectedAmount">$0.00</span>
                </div>

                <!-- ÊåâÈíÆÁªÑ -->
                <div class="btn-group">
                    <button class="btn btn-secondary" id="resetBtn" onclick="resetSelection()">Reset</button>
                    <button class="btn btn-primary" id="confirmChangeBtn" onclick="confirmChange()">Confirm</button>
                </div>
            </div>
        </div>

        <!-- ==================== ÂèçÈ¶àË¶ÜÁõñÂ±Ç ==================== -->
        <div class="feedback-overlay" id="feedbackOverlay">
            <div class="feedback-box">
                <div class="feedback-emoji" id="feedbackEmoji">üòä</div>
                <div class="feedback-text" id="feedbackText">Result text</div>
                <button class="btn btn-success" onclick="nextCustomer()">Next Customer</button>
            </div>
        </div>
    </div>

    <script>
        /**
         * ==================== Ê∏∏ÊàèÊï∞ÊçÆÈÖçÁΩÆ ====================
         */

        /**
         * ÂïÜÂìÅÂ∫ìÔºàÂØπË±°ÂΩ¢ÂºèÔºå‰æø‰∫éÊü•ËØ¢Ôºâ
         */
        const PRODUCTS = {
            lollipop: { name: "Ê£íÊ£íÁ≥ñ", emoji: "üç≠", price: 0.50 },
            apple: { name: "ËãπÊûú", emoji: "üçé", price: 1.00 },
            donut_a: { name: "ÁîúÁîúÂúàA", emoji: "üç©", price: 2.00 },
            donut_b: { name: "ÁîúÁîúÂúàB", emoji: "üç©", price: 2.50 },
            donut_c: { name: "ÁîúÁîúÂúàC", emoji: "üç©", price: 3.00 },
            chips: { name: "ËñØÁâá", emoji: "üçü", price: 1.20 },
            orange: { name: "Ê©ôÂ≠ê", emoji: "üçä", price: 3.00 },
            milk: { name: "ÁâõÂ•∂", emoji: "ü•õ", price: 1.50 },
            meat: { name: "ËÇâ", emoji: "ü•©", price: 15.00 },
            fish: { name: "È±º", emoji: "üêü", price: 15.00 },
            chicken: { name: "È∏°ËÖø", emoji: "üçó", price: 15.00 }
        };

        /**
         * Ë¥ßÊû∂Âå∫ÂüüÈÖçÁΩÆÔºàÊ†∏ÂøÉÈÖçÁΩÆÔºåÊòì‰∫é‰øÆÊîπÔºâ
         */
        const SHELF_CONFIG = [
            {
                id: 'donut-tower',
                name: 'ÁîúÁîúÂúàÂ°î',
                type: 'tower',
                position: { left: '0', top: '8vh' },  // ‰ªéÈ°æÂÆ¢Âå∫ÂüüÂª∂‰º∏‰∏ãÊù•
                size: { width: '120px', height: '62vh' },
                layout: 'vertical',
                products: ['donut_c', 'donut_b', 'donut_a'],
                style: 'shelf-area-tower'
            },
            {
                id: 'snack-corner',
                name: 'Èõ∂È£üËßí',
                type: 'grid',
                position: { left: '0', bottom: '0' },
                size: { width: '200px', height: '28vh' },
                layout: 'grid',
                gridConfig: { rows: 2, cols: 3 },
                products: ['lollipop', 'lollipop', 'lollipop', 'chips', 'chips', 'chips'],
                style: 'shelf-area-grid'
            },
            {
                id: 'fruit-stand',
                name: 'Ê∞¥ÊûúÂ±ïÁ§∫Âè∞',
                type: 'shelves',
                position: { left: '250px', top: '20vh' },
                size: { width: '180px', height: '35vh' },
                layout: 'rows',
                products: [
                    { row: 'top', items: ['orange', 'orange'] },
                    { row: 'middle', items: ['apple', 'apple', 'apple'] },
                    { row: 'bottom', items: ['milk'] }
                ],
                style: 'shelf-area-shelves'
            },
            {
                id: 'seafood-freezer',
                name: 'Êµ∑È≤úÂÜ∞Êüú',
                type: 'freezer',
                position: { right: '20px', top: '15vh' },
                size: { width: '220px', height: '22vh' },
                layout: 'scattered',
                products: ['fish', 'fish', 'fish'],
                label: '$50 each',
                style: 'shelf-area-freezer'
            },
            {
                id: 'meat-freezer',
                name: 'ËÇâÁ±ªÂÜ∞Êüú',
                type: 'freezer',
                position: { right: '20px', top: '42vh' },
                size: { width: '220px', height: '30vh' },
                layout: 'mixed',
                products: ['meat', 'chicken', 'chicken', 'chicken', 'chicken'],
                style: 'shelf-area-freezer'
            }
        ];

        /**
         * Èí±Â∏ÅÁ≥ªÁªüÔºàÊñ∞Âä†Âù°Ë¥ßÂ∏ÅÔºâ
         */
        let cashRegister = {
            '0.05': 10,  '0.10': 10,  '0.20': 10,  '0.50': 10,
            '1': 20,     '2': 10,     '5': 10,     '10': 10,  '50': 5
        };

        /**
         * Ê∏∏ÊàèÁä∂ÊÄÅÁÆ°ÁêÜ
         */
        let gameState = {
            phase: 'order_received',  // order_received, picking_items, making_change, result
            currentCustomer: {
                order: [],           // [{ productId, quantity }, ...]
                bag: [],             // Â∑≤ÁªôÁöÑÂïÜÂìÅ [itemId, itemId, ...]
                totalPrice: 0,
                paid: 0,
                correctChange: 0
            },
            selectedCoins: {},       // Áé©ÂÆ∂ÈÄâÊã©ÁöÑÂ∏ÅÈ¢ù { '0.05': 2, '1': 1, ... }
            selectedAmount: 0,
            score: 0,
            itemIdCounter: 0         // ÂïÜÂìÅÂÆû‰æãIDËÆ°Êï∞Âô®
        };

        /**
         * ==================== Ë¥ßÊû∂Ê∏≤ÊüìÁ≥ªÁªü ====================
         */

        /**
         * ÂàùÂßãÂåñÊâÄÊúâË¥ßÊû∂Âå∫Âüü
         */
        function initShelfAreas() {
            const container = document.getElementById('shelfContainer');
            container.innerHTML = '';
            gameState.itemIdCounter = 0;  // ÈáçÁΩÆIDËÆ°Êï∞Âô®

            SHELF_CONFIG.forEach(config => {
                const areaEl = renderShelfArea(config);
                container.appendChild(areaEl);
            });
        }

        /**
         * Ê†πÊçÆÈÖçÁΩÆÊ∏≤ÊüìÂçï‰∏™Ë¥ßÊû∂Âå∫Âüü
         */
        function renderShelfArea(config) {
            const div = document.createElement('div');
            div.id = config.id;
            div.className = `shelf-area ${config.style}`;

            // ËÆæÁΩÆ‰ΩçÁΩÆÂíåÂ∞∫ÂØ∏
            div.style.cssText = `
                ${config.position.left !== undefined ? `left: ${config.position.left};` : ''}
                ${config.position.right !== undefined ? `right: ${config.position.right};` : ''}
                ${config.position.top !== undefined ? `top: ${config.position.top};` : ''}
                ${config.position.bottom !== undefined ? `bottom: ${config.position.bottom};` : ''}
                width: ${config.size.width};
                height: ${config.size.height};
            `;

            // Ê∑ªÂä†Ê†áÁ≠æÔºàÂ¶ÇÊûúÊúâÔºâ
            if (config.label) {
                const label = document.createElement('div');
                label.className = 'freezer-label';
                label.textContent = config.label;
                div.appendChild(label);
            }

            // Ê†πÊçÆÂ∏ÉÂ±ÄÁ±ªÂûãÊ∏≤ÊüìÂïÜÂìÅ
            renderProducts(div, config.products, config.layout, config.gridConfig);

            return div;
        }

        /**
         * Ê†πÊçÆÂ∏ÉÂ±ÄÁ±ªÂûãÊ∏≤ÊüìÂïÜÂìÅ
         */
        function renderProducts(container, products, layout, gridConfig) {
            if (layout === 'grid' && gridConfig) {
                container.style.gridTemplateRows = `repeat(${gridConfig.rows}, 1fr)`;
                container.style.gridTemplateColumns = `repeat(${gridConfig.cols}, 1fr)`;
            }

            if (layout === 'rows') {
                // ÂàÜÂ±ÇÂ∏ÉÂ±Ä
                products.forEach(rowData => {
                    const rowDiv = document.createElement('div');
                    rowDiv.className = 'shelf-row';
                    rowData.items.forEach(productId => {
                        rowDiv.appendChild(createProductItem(productId));
                    });
                    container.appendChild(rowDiv);
                });
            } else {
                // ÂÖ∂‰ªñÂ∏ÉÂ±ÄÔºàvertical, grid, scattered, mixedÔºâ
                products.forEach(productId => {
                    container.appendChild(createProductItem(productId));
                });
            }
        }

        /**
         * ÂàõÂª∫ÂïÜÂìÅÂÖÉÁ¥†ÔºàÊØè‰∏™ÂÆû‰æãÊúâÂîØ‰∏ÄIDÔºâ
         */
        function createProductItem(productId) {
            const product = PRODUCTS[productId];
            const itemId = `item_${gameState.itemIdCounter++}`;
            const div = document.createElement('div');
            div.className = 'product-item';
            div.dataset.productId = productId;
            div.dataset.itemId = itemId;
            div.onclick = () => pickItem(itemId, productId);
            div.innerHTML = `
                <div class="product-emoji">${product.emoji}</div>
                <div class="product-name">${product.name}</div>
                <div class="product-price">$${product.price.toFixed(2)}</div>
            `;
            return div;
        }

        /**
         * ==================== Ê∏∏ÊàèÊµÅÁ®ã ====================
         */

        /**
         * ÁîüÊàêÈöèÊú∫È°æÂÆ¢ËÆ¢Âçï
         */
        function generateCustomer() {
            // ÁªüËÆ°Ë¥ßÊû∂‰∏äÊØèÁßçÂïÜÂìÅÁöÑÊï∞Èáè
            const productCounts = {};
            SHELF_CONFIG.forEach(config => {
                if (config.layout === 'rows') {
                    config.products.forEach(rowData => {
                        rowData.items.forEach(productId => {
                            productCounts[productId] = (productCounts[productId] || 0) + 1;
                        });
                    });
                } else {
                    config.products.forEach(productId => {
                        productCounts[productId] = (productCounts[productId] || 0) + 1;
                    });
                }
            });

            const availableProducts = Object.keys(productCounts);
            const numItems = 2 + Math.floor(Math.random() * 2); // 2-3ÁßçÂïÜÂìÅ
            const order = [];

            // ÈöèÊú∫ÈÄâÊã©ÂïÜÂìÅ
            const selectedProducts = [];
            for (let i = 0; i < numItems && i < availableProducts.length; i++) {
                let productId;
                do {
                    productId = availableProducts[Math.floor(Math.random() * availableProducts.length)];
                } while (selectedProducts.includes(productId));
                selectedProducts.push(productId);

                // Êï∞Èáè‰∏çË∂ÖËøáË¥ßÊû∂‰∏äËØ•ÂïÜÂìÅÁöÑÊï∞Èáè
                const maxQuantity = Math.min(productCounts[productId], 3);
                const quantity = 1 + Math.floor(Math.random() * maxQuantity);
                order.push({ productId, quantity });
            }

            // ËÆ°ÁÆóÊÄª‰ª∑
            let totalPrice = 0;
            order.forEach(item => {
                totalPrice += PRODUCTS[item.productId].price * item.quantity;
            });
            totalPrice = parseFloat(totalPrice.toFixed(2));

            // ÁîüÊàêÊîØ‰ªòÈáëÈ¢ùÔºàÊÄª‰ª∑ + ÈöèÊú∫ 2-10 ÁæéÂÖÉÔºåÁ°Æ‰øùÈúÄË¶ÅÊâæÈõ∂Ôºâ
            const extra = 2 + Math.floor(Math.random() * 9);
            const paid = parseFloat((totalPrice + extra).toFixed(2));
            const correctChange = parseFloat((paid - totalPrice).toFixed(2));

            return {
                order,
                bag: [],
                totalPrice,
                paid,
                correctChange
            };
        }

        /**
         * ÂºÄÂßãÊé•Âçï
         */
        function startOrder() {
            gameState.phase = 'order_received';
            gameState.currentCustomer = generateCustomer();
            gameState.selectedCoins = {};
            gameState.selectedAmount = 0;

            // ÈáçÊñ∞Ê∏≤ÊüìË¥ßÊû∂ÔºàÈáçÁΩÆÊâÄÊúâÂïÜÂìÅÁä∂ÊÄÅÔºâ
            initShelfAreas();

            // Êõ¥Êñ∞È°æÂÆ¢Âå∫ÂüüUI
            const order = gameState.currentCustomer.order;
            const orderText = order.map(item =>
                `${PRODUCTS[item.productId].emoji} x${item.quantity}`
            ).join('  ');

            document.getElementById('dialogText').textContent = 'I want to buy:';
            document.getElementById('customerOrder').textContent = orderText;
            document.getElementById('bagItems').textContent = '-';
            document.getElementById('paymentInfo').classList.add('hidden');
            document.getElementById('cashierArea').classList.add('hidden');

            // ËøõÂÖ•ÊãøË¥ßÈò∂ÊÆµ
            gameState.phase = 'picking_items';
        }

        /**
         * ÊãøÂïÜÂìÅÁªôÈ°æÂÆ¢ÔºàÊØè‰∏™ÂïÜÂìÅÂÆû‰æãÂè™ËÉΩÁÇπ‰∏ÄÊ¨°Ôºâ
         */
        function pickItem(itemId, productId) {
            if (gameState.phase !== 'picking_items') return;

            const order = gameState.currentCustomer.order;
            const bag = gameState.currentCustomer.bag;

            // Ëé∑ÂèñËØ•ÂïÜÂìÅÂÖÉÁ¥†
            const itemEl = document.querySelector(`[data-item-id="${itemId}"]`);
            if (!itemEl || itemEl.classList.contains('picked')) {
                return; // Â∑≤ÁªèË¢´ÈÄâËøá‰∫Ü
            }

            // Ê£ÄÊü•ÊòØÂê¶Âú®ËÆ¢Âçï‰∏≠
            const orderItem = order.find(item => item.productId === productId);
            if (!orderItem) {
                // ‰∏çÂú®ËÆ¢Âçï‰∏≠
                showTempMessage('Customer didn\'t order this!');
                return;
            }

            // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÊãøÂ§ü‰∫Ü
            const bagCount = bag.filter(id => id === productId).length;
            if (bagCount >= orderItem.quantity) {
                showTempMessage('Already enough of this item!');
                return;
            }

            // Ê†áËÆ∞‰∏∫Â∑≤ÈÄâ
            itemEl.classList.add('picked');

            // Ê∑ªÂä†Âà∞Ë¥≠Áâ©Ë¢ã
            bag.push(productId);
            updateCustomerBag();

            // Ê£ÄÊü•ÊòØÂê¶ÂÆåÊàêËÆ¢Âçï
            checkOrderComplete();
        }

        /**
         * Êõ¥Êñ∞È°æÂÆ¢Ë¥≠Áâ©Ë¢ãÊòæÁ§∫
         */
        function updateCustomerBag() {
            const bag = gameState.currentCustomer.bag;
            const bagEl = document.getElementById('bagItems');

            if (bag.length === 0) {
                bagEl.textContent = '-';
            } else {
                bagEl.textContent = bag.map(id => PRODUCTS[id].emoji).join(' ');
            }
        }

        /**
         * Ê£ÄÊü•ÊòØÂê¶ÂáëÈΩêËÆ¢Âçï
         */
        function checkOrderComplete() {
            const order = gameState.currentCustomer.order;
            const bag = gameState.currentCustomer.bag;

            // Ê£ÄÊü•ÊØè‰∏™ÂïÜÂìÅÊï∞ÈáèÊòØÂê¶ÂåπÈÖç
            const isComplete = order.every(item => {
                const bagCount = bag.filter(id => id === item.productId).length;
                return bagCount === item.quantity;
            });

            if (isComplete) {
                setTimeout(() => startMakingChange(), 500);
            }
        }

        /**
         * ËøõÂÖ•ÊâæÈõ∂Èò∂ÊÆµ
         */
        function startMakingChange() {
            gameState.phase = 'making_change';

            // ÊòæÁ§∫ÊîØ‰ªò‰ø°ÊÅØ
            const customer = gameState.currentCustomer;
            document.getElementById('dialogText').textContent = 'Great! Here\'s the money:';
            document.getElementById('customerOrder').textContent = '';
            document.getElementById('paymentInfo').classList.remove('hidden');
            document.getElementById('paymentAmount').textContent = `Customer gave $${customer.paid.toFixed(2)}`;

            // ÊòæÁ§∫Êî∂Èì∂Âè∞
            document.getElementById('cashierArea').classList.remove('hidden');

            // Êõ¥Êñ∞ËÆ¢Âçï‰ø°ÊÅØ
            const orderSummary = customer.order.map(item =>
                `${PRODUCTS[item.productId].emoji}√ó${item.quantity}`
            ).join(' ');
            document.getElementById('orderSummary').textContent = orderSummary;
            document.getElementById('totalPrice').textContent = `$${customer.totalPrice.toFixed(2)}`;
            document.getElementById('customerPaid').textContent = `$${customer.paid.toFixed(2)}`;
            document.getElementById('correctChange').textContent = `$${customer.correctChange.toFixed(2)}`;

            // ÂàùÂßãÂåñÈí±ÁÆ±
            renderCashRegister();
            updateSelectedAmount();
            updateCoinButtons();
        }

        /**
         * Ê∏≤ÊüìÈí±ÁÆ±
         */
        function renderCashRegister() {
            const grid = document.getElementById('cashGrid');
            grid.innerHTML = '';

            const denominations = ['0.05', '0.10', '0.20', '0.50', '1', '2', '5', '10', '50'];
            denominations.forEach(denom => {
                const btn = document.createElement('button');
                btn.className = 'coin-btn';
                btn.id = `coin-${denom}`;
                btn.dataset.denomination = denom;
                btn.onclick = () => toggleCoin(denom);
                btn.disabled = cashRegister[denom] === 0;
                btn.innerHTML = `
                    <div class="coin-value">$${parseFloat(denom).toFixed(2)}</div>
                    <div class="coin-stock">√ó${cashRegister[denom]}</div>
                `;
                grid.appendChild(btn);
            });
        }

        /**
         * ÂàáÊç¢Â∏ÅÈ¢ùÈÄâÊã©ÔºàÁÇπÂáªÈÄâ‰∏≠ÔºåÂÜçÁÇπÂèñÊ∂àÔºâ
         */
        function toggleCoin(denomination) {
            if (gameState.phase !== 'making_change') return;

            const btn = document.getElementById(`coin-${denomination}`);
            const stock = cashRegister[denomination];
            const selectedCount = gameState.selectedCoins[denomination] || 0;

            if (btn.classList.contains('selected')) {
                // ÂèñÊ∂àÈÄâÊã©
                if (selectedCount > 0) {
                    gameState.selectedCoins[denomination] = selectedCount - 1;
                    gameState.selectedAmount -= parseFloat(denomination);
                    gameState.selectedAmount = parseFloat(gameState.selectedAmount.toFixed(2));

                    if (gameState.selectedCoins[denomination] === 0) {
                        delete gameState.selectedCoins[denomination];
                        btn.classList.remove('selected');
                    }
                }
            } else {
                // Ê∑ªÂä†ÈÄâÊã©
                if (selectedCount >= stock) {
                    showTempMessage('No more of this denomination!');
                    return;
                }

                gameState.selectedCoins[denomination] = selectedCount + 1;
                gameState.selectedAmount += parseFloat(denomination);
                gameState.selectedAmount = parseFloat(gameState.selectedAmount.toFixed(2));
                btn.classList.add('selected');
            }

            updateSelectedAmount();
            updateCoinButtons();
        }

        /**
         * ÈáçÈÄâ
         */
        function resetSelection() {
            gameState.selectedCoins = {};
            gameState.selectedAmount = 0;

            // ÁßªÈô§ÊâÄÊúâÈ´ò‰∫Æ
            document.querySelectorAll('.coin-btn').forEach(btn => {
                btn.classList.remove('selected');
            });

            updateSelectedAmount();
            updateCoinButtons();
        }

        /**
         * Êõ¥Êñ∞Â∏ÅÈ¢ùÊåâÈíÆÊòæÁ§∫
         */
        function updateCoinButtons() {
            const denominations = ['0.05', '0.10', '0.20', '0.50', '1', '2', '5', '10', '50'];
            denominations.forEach(denom => {
                const btn = document.getElementById(`coin-${denom}`);
                if (btn) {
                    const selectedCount = gameState.selectedCoins[denom] || 0;
                    const stock = cashRegister[denom];

                    // Êõ¥Êñ∞Â∫ìÂ≠òÊòæÁ§∫ÔºàÊòæÁ§∫Ââ©‰ΩôÂèØÈÄâÊï∞ÈáèÔºâ
                    const stockEl = btn.querySelector('.coin-stock');
                    if (selectedCount > 0) {
                        stockEl.textContent = `Selected √ó${selectedCount} (${stock - selectedCount} left)`;
                    } else {
                        stockEl.textContent = `√ó${stock}`;
                    }
                }
            });
        }

        /**
         * Êõ¥Êñ∞Â∑≤ÈÄâÈáëÈ¢ùÊòæÁ§∫
         */
        function updateSelectedAmount() {
            document.getElementById('selectedAmount').textContent = `$${gameState.selectedAmount.toFixed(2)}`;
        }

        /**
         * Á°ÆËÆ§ÊâæÈõ∂
         */
        function confirmChange() {
            if (gameState.phase !== 'making_change') return;

            if (Object.keys(gameState.selectedCoins).length === 0) {
                showTempMessage('Please select coins first!');
                return;
            }

            const selectedAmount = gameState.selectedAmount;
            const correctChange = gameState.currentCustomer.correctChange;

            gameState.phase = 'result';

            // Âà§Êñ≠ÊòØÂê¶Ê≠£Á°Æ
            const isCorrect = Math.abs(selectedAmount - correctChange) < 0.01;

            // ÊòæÁ§∫ÂèçÈ¶à
            const overlay = document.getElementById('feedbackOverlay');
            const emoji = document.getElementById('feedbackEmoji');
            const text = document.getElementById('feedbackText');

            if (isCorrect) {
                emoji.textContent = 'üòä';
                text.textContent = 'Perfect! Customer is happy!\nCorrect change!';
                gameState.score++;
            } else {
                emoji.textContent = 'üò°';
                text.textContent = `Customer is angry!\nYou gave $${selectedAmount.toFixed(2)}\nShould be $${correctChange.toFixed(2)}`;
                gameState.score = 0;
            }

            overlay.classList.add('show');
        }

        /**
         * ÊúçÂä°‰∏ã‰∏Ä‰ΩçÈ°æÂÆ¢
         */
        function nextCustomer() {
            document.getElementById('feedbackOverlay').classList.remove('show');
            startOrder();
        }

        /**
         * ==================== ËæÖÂä©ÂáΩÊï∞ ====================
         */

        /**
         * ÊòæÁ§∫‰∏¥Êó∂ÊèêÁ§∫Ê∂àÊÅØ
         */
        function showTempMessage(message) {
            const dialogText = document.getElementById('dialogText');
            const originalText = dialogText.textContent;
            dialogText.textContent = message;
            dialogText.style.color = '#d32f2f';

            setTimeout(() => {
                dialogText.textContent = originalText;
                dialogText.style.color = '#333';
            }, 1500);
        }

        /**
         * ==================== Ê∏∏ÊàèÂàùÂßãÂåñ ====================
         */
        window.addEventListener('DOMContentLoaded', function() {
            // ÂàùÂßãÂåñË¥ßÊû∂
            initShelfAreas();

            // ÂºÄÂßãÁ¨¨‰∏ÄËΩÆ
            startOrder();
        });
    </script>
</body>
</html>
