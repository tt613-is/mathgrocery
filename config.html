<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Grocery - é…ç½®ç¼–è¾‘å™¨</title>
    <style>
        /* ==================== å…¨å±€æ ·å¼ ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        /* ==================== ä¸»å®¹å™¨ ==================== */
        .config-container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 40px);
        }

        /* ==================== å¤´éƒ¨ ==================== */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        /* ==================== ä¸»å†…å®¹åŒºåŸŸ ==================== */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* ==================== å·¦ä¾§è´§æ¶åˆ—è¡¨ (20%) ==================== */
        .shelf-list {
            width: 20%;
            border-right: 2px solid #e0e0e0;
            overflow-y: auto;
            background: #f5f5f5;
        }

        .shelf-list-header {
            padding: 15px;
            background: #667eea;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .shelf-item {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }

        .shelf-item:hover {
            background: #f0f0f0;
        }

        .shelf-item.active {
            background: #e8eaf6;
            border-left: 4px solid #667eea;
        }

        .shelf-item-name {
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
        }

        .shelf-item-meta {
            font-size: 12px;
            color: #666;
        }

        .add-shelf-btn {
            width: 100%;
            padding: 15px;
            background: #667eea;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.2s;
        }

        .add-shelf-btn:hover {
            background: #5568d3;
        }

        /* ==================== ä¸­é—´ç¼–è¾‘åŒºåŸŸ (50%) ==================== */
        .edit-area {
            width: 50%;
            overflow-y: auto;
            padding: 30px;
        }

        .edit-section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #667eea;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 8px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: #555;
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }

        .form-row {
            display: flex;
            gap: 15px;
        }

        .form-col {
            flex: 1;
        }

        .input-group {
            display: flex;
            gap: 8px;
        }

        .input-group input {
            flex: 1;
        }

        .input-group select {
            width: 80px;
        }

        /* ==================== äº§å“é€‰æ‹©å™¨ ==================== */
        .product-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .product-option {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }

        .product-option:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .product-option.selected {
            border-color: #667eea;
            background: #e8eaf6;
        }

        .product-emoji {
            font-size: 32px;
            margin-bottom: 5px;
        }

        .product-name {
            font-size: 12px;
            color: #666;
        }

        .product-count {
            margin-top: 5px;
            font-size: 14px;
            font-weight: 600;
            color: #667eea;
        }

        /* ==================== ä»·æ ¼æ ‡ç­¾ç¼–è¾‘å™¨ ==================== */
        .price-label-editor {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .toggle-switch {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .3s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #667eea;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .price-items-list {
            margin-top: 10px;
        }

        .price-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .remove-item-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .add-item-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }

        /* ==================== å³ä¾§é¢„è§ˆåŒºåŸŸ (30%) ==================== */
        .preview-area {
            width: 30%;
            border-left: 2px solid #e0e0e0;
            overflow-y: auto;
            background: #f5f5f5;
        }

        .preview-header {
            padding: 15px;
            background: #667eea;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .preview-content {
            padding: 20px;
        }

        .preview-shelf {
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
        }

        .preview-shelf-name {
            font-weight: 600;
            margin-bottom: 10px;
            color: #667eea;
        }

        .preview-info {
            font-size: 12px;
            color: #666;
            line-height: 1.6;
        }

        .preview-products {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .preview-product {
            font-size: 24px;
            background: #f0f0f0;
            padding: 8px;
            border-radius: 6px;
        }

        /* ==================== åº•éƒ¨æ“ä½œæ  ==================== */
        .footer-actions {
            padding: 20px 30px;
            background: #f5f5f5;
            border-top: 2px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .action-group {
            display: flex;
            gap: 15px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #4caf50;
            color: white;
        }

        .btn-secondary:hover {
            background: #45a049;
        }

        .btn-warning {
            background: #ff9800;
            color: white;
        }

        .btn-warning:hover {
            background: #fb8c00;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #e53935;
        }

        .btn-outline {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn-outline:hover {
            background: #e8eaf6;
        }

        /* ==================== æ–‡ä»¶ä¸Šä¼ éšè— ==================== */
        .file-input {
            display: none;
        }

        /* ==================== é€šçŸ¥æç¤º ==================== */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification.success {
            background: #4caf50;
        }

        .notification.error {
            background: #f44336;
        }

        .notification.info {
            background: #2196f3;
        }

        /* ==================== ç©ºçŠ¶æ€ ==================== */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .empty-state-text {
            font-size: 16px;
        }

        /* ==================== åˆ é™¤æŒ‰é’® ==================== */
        .delete-shelf-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 20px;
        }

        .delete-shelf-btn:hover {
            background: #d32f2f;
        }
    </style>
</head>
<body>
    <div class="config-container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <h1>ğŸ›’ Math Grocery é…ç½®ç¼–è¾‘å™¨</h1>
            <div class="header-actions">
                <button class="btn btn-outline" onclick="previewGame()">ğŸ® é¢„è§ˆæ¸¸æˆ</button>
            </div>
        </div>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <div class="main-content">
            <!-- å·¦ä¾§è´§æ¶åˆ—è¡¨ -->
            <div class="shelf-list">
                <div class="shelf-list-header">è´§æ¶åˆ—è¡¨</div>
                <div id="shelfListContainer"></div>
                <button class="add-shelf-btn" onclick="addNewShelf()">+ æ·»åŠ æ–°è´§æ¶</button>
            </div>

            <!-- ä¸­é—´ç¼–è¾‘åŒºåŸŸ -->
            <div class="edit-area" id="editArea">
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ“</div>
                    <div class="empty-state-text">è¯·ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªè´§æ¶è¿›è¡Œç¼–è¾‘</div>
                </div>
            </div>

            <!-- å³ä¾§é¢„è§ˆåŒºåŸŸ -->
            <div class="preview-area">
                <div class="preview-header">å®æ—¶é¢„è§ˆ</div>
                <div class="preview-content" id="previewContent">
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ‘ï¸</div>
                        <div class="empty-state-text">é€‰æ‹©è´§æ¶æŸ¥çœ‹é¢„è§ˆ</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- åº•éƒ¨æ“ä½œæ  -->
        <div class="footer-actions">
            <div class="action-group">
                <button class="btn btn-primary" onclick="saveConfig()">ğŸ’¾ ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨</button>
                <button class="btn btn-secondary" onclick="exportConfig()">ğŸ“¥ å¯¼å‡ºJSONæ–‡ä»¶</button>
                <button class="btn btn-outline" onclick="document.getElementById('fileInput').click()">ğŸ“¤ åŠ è½½JSONæ–‡ä»¶</button>
                <input type="file" id="fileInput" class="file-input" accept=".json" onchange="loadConfig(event)">
            </div>
            <div class="action-group">
                <button class="btn btn-warning" onclick="resetConfig()">ğŸ”„ é‡ç½®ä¸ºé»˜è®¤</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== å…¨å±€çŠ¶æ€ ====================
        let config = null;
        let selectedShelfIndex = null;
        let productCounts = {};

        // ==================== åˆå§‹åŒ– ====================
        async function init() {
            // å°è¯•ä»LocalStorageåŠ è½½
            const savedConfig = localStorage.getItem('mathGroceryConfig');
            if (savedConfig) {
                config = JSON.parse(savedConfig);
                showNotification('å·²ä»æœ¬åœ°å­˜å‚¨åŠ è½½é…ç½®', 'info');
            } else {
                // åŠ è½½é»˜è®¤é…ç½®
                try {
                    const response = await fetch('game-config.json');
                    config = await response.json();
                    showNotification('å·²åŠ è½½é»˜è®¤é…ç½®', 'info');
                } catch (error) {
                    console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
                    showNotification('åŠ è½½é…ç½®å¤±è´¥ï¼Œä½¿ç”¨ç©ºé…ç½®', 'error');
                    config = createEmptyConfig();
                }
            }
            renderShelfList();
        }

        // ==================== åˆ›å»ºç©ºé…ç½® ====================
        function createEmptyConfig() {
            return {
                version: "0.3.1",
                customerArea: {
                    height: "25vh",
                    background: "linear-gradient(180deg, #e3f2fd 0%, #bbdefb 100%)"
                },
                products: {
                    lollipop: { name: "æ£’æ£’ç³–", emoji: "ğŸ­", price: 0.50 },
                    apple: { name: "è‹¹æœ", emoji: "ğŸ", price: 1.00 },
                    donut_a: { name: "ç”œç”œåœˆA", emoji: "ğŸ©", price: 2.50 },
                    donut_b: { name: "ç”œç”œåœˆB", emoji: "ğŸ©", price: 2.55 },
                    donut_c: { name: "ç”œç”œåœˆC", emoji: "ğŸ©", price: 2.75 },
                    chips: { name: "è–¯ç‰‡", emoji: "ğŸŸ", price: 1.20 },
                    orange: { name: "æ©™å­", emoji: "ğŸŠ", price: 3.00 },
                    milk: { name: "ç‰›å¥¶", emoji: "ğŸ¥›", price: 1.50 },
                    meat: { name: "è‚‰", emoji: "ğŸ¥©", price: 15.00 },
                    fish: { name: "é±¼", emoji: "ğŸŸ", price: 15.00 },
                    chicken: { name: "é¸¡è…¿", emoji: "ğŸ—", price: 15.00 }
                },
                shelves: [],
                cashRegister: {
                    "0.05": 10, "0.10": 10, "0.20": 10, "0.50": 10,
                    "1": 20, "2": 10, "5": 10, "10": 10, "50": 5
                }
            };
        }

        // ==================== æ¸²æŸ“è´§æ¶åˆ—è¡¨ ====================
        function renderShelfList() {
            const container = document.getElementById('shelfListContainer');
            container.innerHTML = '';

            if (!config.shelves || config.shelves.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-text">æš‚æ— è´§æ¶</div></div>';
                return;
            }

            config.shelves.forEach((shelf, index) => {
                const item = document.createElement('div');
                item.className = 'shelf-item';
                if (index === selectedShelfIndex) {
                    item.classList.add('active');
                }
                item.onclick = () => selectShelf(index);

                item.innerHTML = `
                    <div class="shelf-item-name">${shelf.name}</div>
                    <div class="shelf-item-meta">ID: ${shelf.id} | ç±»å‹: ${shelf.type}</div>
                `;

                container.appendChild(item);
            });
        }

        // ==================== é€‰æ‹©è´§æ¶ ====================
        function selectShelf(index) {
            selectedShelfIndex = index;
            renderShelfList();
            renderEditArea();
            renderPreview();
        }

        // ==================== æ¸²æŸ“ç¼–è¾‘åŒºåŸŸ ====================
        function renderEditArea() {
            if (selectedShelfIndex === null) return;

            const shelf = config.shelves[selectedShelfIndex];
            const editArea = document.getElementById('editArea');

            // ç»Ÿè®¡äº§å“æ•°é‡
            productCounts = {};
            const flatProducts = flattenProducts(shelf.products);
            flatProducts.forEach(productId => {
                productCounts[productId] = (productCounts[productId] || 0) + 1;
            });

            editArea.innerHTML = `
                <!-- åŸºæœ¬ä¿¡æ¯ -->
                <div class="edit-section">
                    <div class="section-title">åŸºæœ¬ä¿¡æ¯</div>

                    <div class="form-group">
                        <label class="form-label">è´§æ¶åç§°</label>
                        <input type="text" class="form-input" value="${shelf.name}"
                               onchange="updateShelf('name', this.value)">
                    </div>

                    <div class="form-group">
                        <label class="form-label">è´§æ¶ID</label>
                        <input type="text" class="form-input" value="${shelf.id}"
                               onchange="updateShelf('id', this.value)">
                    </div>

                    <div class="form-group">
                        <label class="form-label">è´§æ¶ç±»å‹</label>
                        <input type="text" class="form-input" value="${shelf.type}"
                               onchange="updateShelf('type', this.value)">
                    </div>
                </div>

                <!-- ä½ç½®è®¾ç½® -->
                <div class="edit-section">
                    <div class="section-title">ä½ç½®è®¾ç½®</div>

                    <div class="form-row">
                        <div class="form-col">
                            <label class="form-label">Left</label>
                            <div class="input-group">
                                <input type="text" class="form-input" value="${shelf.position.left || ''}"
                                       onchange="updatePosition('left', this.value)">
                            </div>
                        </div>
                        <div class="form-col">
                            <label class="form-label">Right</label>
                            <div class="input-group">
                                <input type="text" class="form-input" value="${shelf.position.right || ''}"
                                       onchange="updatePosition('right', this.value)">
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-col">
                            <label class="form-label">Top</label>
                            <div class="input-group">
                                <input type="text" class="form-input" value="${shelf.position.top || ''}"
                                       onchange="updatePosition('top', this.value)">
                            </div>
                        </div>
                        <div class="form-col">
                            <label class="form-label">Bottom</label>
                            <div class="input-group">
                                <input type="text" class="form-input" value="${shelf.position.bottom || ''}"
                                       onchange="updatePosition('bottom', this.value)">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å°ºå¯¸è®¾ç½® -->
                <div class="edit-section">
                    <div class="section-title">å°ºå¯¸è®¾ç½®</div>

                    <div class="form-row">
                        <div class="form-col">
                            <label class="form-label">Width</label>
                            <input type="text" class="form-input" value="${shelf.size.width}"
                                   onchange="updateSize('width', this.value)">
                        </div>
                        <div class="form-col">
                            <label class="form-label">Height</label>
                            <input type="text" class="form-input" value="${shelf.size.height}"
                                   onchange="updateSize('height', this.value)">
                        </div>
                    </div>
                </div>

                <!-- å¸ƒå±€è®¾ç½® -->
                <div class="edit-section">
                    <div class="section-title">å¸ƒå±€è®¾ç½®</div>

                    <div class="form-group">
                        <label class="form-label">å¸ƒå±€ç±»å‹</label>
                        <select class="form-select" onchange="updateShelf('layout', this.value)">
                            <option value="vertical" ${shelf.layout === 'vertical' ? 'selected' : ''}>å‚ç›´å¸ƒå±€ (vertical)</option>
                            <option value="grid" ${shelf.layout === 'grid' ? 'selected' : ''}>ç½‘æ ¼å¸ƒå±€ (grid)</option>
                            <option value="rows" ${shelf.layout === 'rows' ? 'selected' : ''}>åˆ†å±‚å¸ƒå±€ (rows)</option>
                            <option value="scattered" ${shelf.layout === 'scattered' ? 'selected' : ''}>æ•£åˆ—å¸ƒå±€ (scattered)</option>
                            <option value="mixed" ${shelf.layout === 'mixed' ? 'selected' : ''}>æ··åˆå¸ƒå±€ (mixed)</option>
                        </select>
                    </div>

                    ${shelf.layout === 'grid' ? `
                    <div class="form-row">
                        <div class="form-col">
                            <label class="form-label">è¡Œæ•° (Rows)</label>
                            <input type="number" class="form-input" value="${shelf.gridConfig?.rows || 2}"
                                   onchange="updateGridConfig('rows', parseInt(this.value))">
                        </div>
                        <div class="form-col">
                            <label class="form-label">åˆ—æ•° (Cols)</label>
                            <input type="number" class="form-input" value="${shelf.gridConfig?.cols || 3}"
                                   onchange="updateGridConfig('cols', parseInt(this.value))">
                        </div>
                    </div>
                    ` : ''}
                </div>

                <!-- å•†å“é€‰æ‹© -->
                <div class="edit-section">
                    <div class="section-title">å•†å“é€‰æ‹©</div>
                    <div class="product-selector" id="productSelector"></div>
                </div>

                <!-- ä»·æ ¼æ ‡ç­¾ -->
                <div class="edit-section">
                    <div class="section-title">ä»·æ ¼æ ‡ç­¾</div>
                    <div class="price-label-editor" id="priceLabelEditor"></div>
                </div>

                <!-- åˆ é™¤è´§æ¶ -->
                <div class="edit-section">
                    <button class="delete-shelf-btn" onclick="deleteShelf()">ğŸ—‘ï¸ åˆ é™¤æ­¤è´§æ¶</button>
                </div>
            `;

            renderProductSelector();
            renderPriceLabelEditor();
        }

        // ==================== æ¸²æŸ“äº§å“é€‰æ‹©å™¨ ====================
        function renderProductSelector() {
            const container = document.getElementById('productSelector');
            if (!container) return;

            container.innerHTML = '';

            Object.keys(config.products).forEach(productId => {
                const product = config.products[productId];
                const count = productCounts[productId] || 0;

                const option = document.createElement('div');
                option.className = 'product-option';
                if (count > 0) {
                    option.classList.add('selected');
                }

                option.innerHTML = `
                    <div class="product-emoji">${product.emoji}</div>
                    <div class="product-name">${product.name}</div>
                    <div class="product-count">x${count}</div>
                `;

                option.onclick = () => toggleProduct(productId);
                container.appendChild(option);
            });
        }

        // ==================== åˆ‡æ¢äº§å“ ====================
        function toggleProduct(productId) {
            const shelf = config.shelves[selectedShelfIndex];
            const flatProducts = flattenProducts(shelf.products);

            const index = flatProducts.indexOf(productId);
            if (index > -1) {
                // ç§»é™¤ä¸€ä¸ª
                flatProducts.splice(index, 1);
            } else {
                // æ·»åŠ ä¸€ä¸ª
                flatProducts.push(productId);
            }

            // æ ¹æ®å¸ƒå±€ç±»å‹é‡å»ºproductsæ•°ç»„
            if (shelf.layout === 'rows') {
                // ä¿æŒåŸæœ‰çš„è¡Œç»“æ„ï¼Œåªä¿®æ”¹items
                shelf.products = shelf.products.map(row => ({
                    row: row.row,
                    items: []
                }));
                // ç®€åŒ–ï¼šå°†æ‰€æœ‰äº§å“æ”¾å…¥ç¬¬ä¸€è¡Œ
                if (shelf.products.length > 0) {
                    shelf.products[0].items = flatProducts;
                }
            } else {
                shelf.products = flatProducts;
            }

            renderEditArea();
            renderPreview();
        }

        // ==================== æ‰å¹³åŒ–äº§å“åˆ—è¡¨ ====================
        function flattenProducts(products) {
            if (!Array.isArray(products)) return [];

            const flat = [];
            products.forEach(item => {
                if (typeof item === 'string') {
                    flat.push(item);
                } else if (item.items && Array.isArray(item.items)) {
                    flat.push(...item.items);
                }
            });
            return flat;
        }

        // ==================== æ¸²æŸ“ä»·æ ¼æ ‡ç­¾ç¼–è¾‘å™¨ ====================
        function renderPriceLabelEditor() {
            const container = document.getElementById('priceLabelEditor');
            if (!container) return;

            const shelf = config.shelves[selectedShelfIndex];
            const priceLabel = shelf.priceLabel || { show: false };

            container.innerHTML = `
                <div class="toggle-switch">
                    <label class="switch">
                        <input type="checkbox" ${priceLabel.show ? 'checked' : ''}
                               onchange="updatePriceLabel('show', this.checked)">
                        <span class="slider"></span>
                    </label>
                    <span>æ˜¾ç¤ºä»·æ ¼æ ‡ç­¾</span>
                </div>

                ${priceLabel.show ? `
                    <div class="form-group">
                        <label class="form-label">æ ‡ç­¾ä½ç½®</label>
                        <select class="form-select" onchange="updatePriceLabel('position', this.value)">
                            <option value="right" ${priceLabel.position === 'right' ? 'selected' : ''}>å³ä¾§</option>
                            <option value="left" ${priceLabel.position === 'left' ? 'selected' : ''}>å·¦ä¾§</option>
                            <option value="top" ${priceLabel.position === 'top' ? 'selected' : ''}>é¡¶éƒ¨</option>
                            <option value="bottom" ${priceLabel.position === 'bottom' ? 'selected' : ''}>åº•éƒ¨</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">äº§å“åç§°</label>
                        <input type="text" class="form-input" value="${priceLabel.productName || ''}"
                               onchange="updatePriceLabel('productName', this.value)">
                    </div>

                    ${!priceLabel.items ? `
                    <div class="form-group">
                        <label class="form-label">ä»·æ ¼</label>
                        <input type="text" class="form-input" value="${priceLabel.price || ''}"
                               onchange="updatePriceLabel('price', this.value)">
                    </div>
                    ` : ''}

                    <div class="form-group">
                        <label class="form-label">å•ä½</label>
                        <input type="text" class="form-input" value="${priceLabel.unit || 'each'}"
                               onchange="updatePriceLabel('unit', this.value)">
                    </div>

                    <div class="form-group">
                        <label class="form-label">æŠ˜æ‰£ä¿¡æ¯</label>
                        <input type="text" class="form-input" value="${priceLabel.discount || ''}"
                               placeholder="ä¾‹å¦‚: 2 for $0.90"
                               onchange="updatePriceLabel('discount', this.value || null)">
                    </div>

                    <div class="form-group">
                        <label class="form-label">ä»·æ ¼åˆ—è¡¨ï¼ˆå¤šå•†å“è´§æ¶ï¼‰</label>
                        <div class="price-items-list" id="priceItemsList">
                            ${(priceLabel.items || []).map((item, idx) => `
                                <div class="price-item">
                                    <input type="text" class="form-input" placeholder="å•†å“å"
                                           value="${item.name}"
                                           onchange="updatePriceItem(${idx}, 'name', this.value)">
                                    <input type="text" class="form-input" placeholder="ä»·æ ¼"
                                           value="${item.price}"
                                           onchange="updatePriceItem(${idx}, 'price', this.value)">
                                    <button class="remove-item-btn" onclick="removePriceItem(${idx})">åˆ é™¤</button>
                                </div>
                            `).join('')}
                        </div>
                        <button class="add-item-btn" onclick="addPriceItem()">+ æ·»åŠ å•†å“</button>
                    </div>
                ` : ''}
            `;
        }

        // ==================== æ›´æ–°è´§æ¶å±æ€§ ====================
        function updateShelf(key, value) {
            if (selectedShelfIndex === null) return;
            config.shelves[selectedShelfIndex][key] = value;
            renderShelfList();
            renderPreview();
        }

        function updatePosition(key, value) {
            if (selectedShelfIndex === null) return;
            const shelf = config.shelves[selectedShelfIndex];
            if (value === '') {
                delete shelf.position[key];
            } else {
                shelf.position[key] = value;
            }
            renderPreview();
        }

        function updateSize(key, value) {
            if (selectedShelfIndex === null) return;
            config.shelves[selectedShelfIndex].size[key] = value;
            renderPreview();
        }

        function updateGridConfig(key, value) {
            if (selectedShelfIndex === null) return;
            const shelf = config.shelves[selectedShelfIndex];
            if (!shelf.gridConfig) shelf.gridConfig = {};
            shelf.gridConfig[key] = value;
            renderPreview();
        }

        function updatePriceLabel(key, value) {
            if (selectedShelfIndex === null) return;
            const shelf = config.shelves[selectedShelfIndex];
            if (!shelf.priceLabel) shelf.priceLabel = {};
            shelf.priceLabel[key] = value;
            renderPriceLabelEditor();
            renderPreview();
        }

        function updatePriceItem(index, key, value) {
            if (selectedShelfIndex === null) return;
            const shelf = config.shelves[selectedShelfIndex];
            if (!shelf.priceLabel.items) shelf.priceLabel.items = [];
            shelf.priceLabel.items[index][key] = value;
            renderPreview();
        }

        function addPriceItem() {
            if (selectedShelfIndex === null) return;
            const shelf = config.shelves[selectedShelfIndex];
            if (!shelf.priceLabel.items) shelf.priceLabel.items = [];
            shelf.priceLabel.items.push({ name: '', price: '' });
            renderPriceLabelEditor();
        }

        function removePriceItem(index) {
            if (selectedShelfIndex === null) return;
            const shelf = config.shelves[selectedShelfIndex];
            shelf.priceLabel.items.splice(index, 1);
            renderPriceLabelEditor();
            renderPreview();
        }

        // ==================== æ¸²æŸ“é¢„è§ˆ ====================
        function renderPreview() {
            const container = document.getElementById('previewContent');
            if (selectedShelfIndex === null) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ‘ï¸</div>
                        <div class="empty-state-text">é€‰æ‹©è´§æ¶æŸ¥çœ‹é¢„è§ˆ</div>
                    </div>
                `;
                return;
            }

            const shelf = config.shelves[selectedShelfIndex];
            const flatProducts = flattenProducts(shelf.products);

            container.innerHTML = `
                <div class="preview-shelf">
                    <div class="preview-shelf-name">${shelf.name}</div>
                    <div class="preview-info">
                        <strong>ID:</strong> ${shelf.id}<br>
                        <strong>ç±»å‹:</strong> ${shelf.type}<br>
                        <strong>å¸ƒå±€:</strong> ${shelf.layout}<br>
                        <strong>ä½ç½®:</strong> ${JSON.stringify(shelf.position)}<br>
                        <strong>å°ºå¯¸:</strong> ${shelf.size.width} x ${shelf.size.height}<br>
                        ${shelf.gridConfig ? `<strong>ç½‘æ ¼:</strong> ${shelf.gridConfig.rows}è¡Œ x ${shelf.gridConfig.cols}åˆ—<br>` : ''}
                        <strong>å•†å“æ•°é‡:</strong> ${flatProducts.length}
                    </div>
                    <div class="preview-products">
                        ${flatProducts.map(productId => {
                            const product = config.products[productId];
                            return `<div class="preview-product" title="${product.name}">${product.emoji}</div>`;
                        }).join('')}
                    </div>
                    ${shelf.priceLabel && shelf.priceLabel.show ? `
                        <div class="preview-info" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                            <strong>ä»·æ ¼æ ‡ç­¾:</strong><br>
                            ${shelf.priceLabel.productName ? `äº§å“: ${shelf.priceLabel.productName}<br>` : ''}
                            ${shelf.priceLabel.price ? `ä»·æ ¼: ${shelf.priceLabel.price}<br>` : ''}
                            ${shelf.priceLabel.items ? `å•†å“åˆ—è¡¨: ${shelf.priceLabel.items.map(i => `${i.name} ${i.price}`).join(', ')}<br>` : ''}
                            ${shelf.priceLabel.unit ? `å•ä½: ${shelf.priceLabel.unit}<br>` : ''}
                            ${shelf.priceLabel.discount ? `æŠ˜æ‰£: ${shelf.priceLabel.discount}` : ''}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // ==================== æ·»åŠ æ–°è´§æ¶ ====================
        function addNewShelf() {
            const newShelf = {
                id: `shelf-${Date.now()}`,
                name: "æ–°è´§æ¶",
                type: "custom",
                position: { left: "0", top: "0" },
                size: { width: "200px", height: "200px" },
                layout: "grid",
                gridConfig: { rows: 2, cols: 2 },
                products: [],
                style: "shelf-area-grid",
                priceLabel: {
                    show: false
                }
            };

            config.shelves.push(newShelf);
            selectedShelfIndex = config.shelves.length - 1;
            renderShelfList();
            renderEditArea();
            renderPreview();
            showNotification('å·²æ·»åŠ æ–°è´§æ¶', 'success');
        }

        // ==================== åˆ é™¤è´§æ¶ ====================
        function deleteShelf() {
            if (selectedShelfIndex === null) return;

            if (confirm('ç¡®å®šè¦åˆ é™¤æ­¤è´§æ¶å—ï¼Ÿ')) {
                config.shelves.splice(selectedShelfIndex, 1);
                selectedShelfIndex = null;
                renderShelfList();
                document.getElementById('editArea').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“</div>
                        <div class="empty-state-text">è¯·ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªè´§æ¶è¿›è¡Œç¼–è¾‘</div>
                    </div>
                `;
                renderPreview();
                showNotification('å·²åˆ é™¤è´§æ¶', 'success');
            }
        }

        // ==================== ä¿å­˜é…ç½® ====================
        function saveConfig() {
            try {
                localStorage.setItem('mathGroceryConfig', JSON.stringify(config, null, 2));
                showNotification('é…ç½®å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨', 'success');
            } catch (error) {
                console.error('ä¿å­˜å¤±è´¥:', error);
                showNotification('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            }
        }

        // ==================== å¯¼å‡ºé…ç½® ====================
        function exportConfig() {
            const dataStr = JSON.stringify(config, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = 'game-config.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showNotification('é…ç½®å·²å¯¼å‡º', 'success');
        }

        // ==================== åŠ è½½é…ç½® ====================
        function loadConfig(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    config = JSON.parse(e.target.result);
                    selectedShelfIndex = null;
                    renderShelfList();
                    document.getElementById('editArea').innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“</div>
                            <div class="empty-state-text">è¯·ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªè´§æ¶è¿›è¡Œç¼–è¾‘</div>
                        </div>
                    `;
                    renderPreview();
                    showNotification('é…ç½®æ–‡ä»¶åŠ è½½æˆåŠŸ', 'success');
                } catch (error) {
                    console.error('è§£æé…ç½®å¤±è´¥:', error);
                    showNotification('é…ç½®æ–‡ä»¶æ ¼å¼é”™è¯¯', 'error');
                }
            };
            reader.readAsText(file);
        }

        // ==================== é‡ç½®é…ç½® ====================
        async function resetConfig() {
            if (!confirm('ç¡®å®šè¦é‡ç½®ä¸ºé»˜è®¤é…ç½®å—ï¼Ÿå½“å‰çš„ä¿®æ”¹å°†ä¸¢å¤±ï¼')) return;

            try {
                const response = await fetch('game-config.json');
                config = await response.json();
                selectedShelfIndex = null;
                renderShelfList();
                document.getElementById('editArea').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“</div>
                        <div class="empty-state-text">è¯·ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªè´§æ¶è¿›è¡Œç¼–è¾‘</div>
                    </div>
                `;
                renderPreview();
                showNotification('å·²é‡ç½®ä¸ºé»˜è®¤é…ç½®', 'success');
            } catch (error) {
                console.error('é‡ç½®å¤±è´¥:', error);
                showNotification('é‡ç½®å¤±è´¥: ' + error.message, 'error');
            }
        }

        // ==================== é¢„è§ˆæ¸¸æˆ ====================
        function previewGame() {
            // ä¿å­˜å½“å‰é…ç½®åˆ°sessionStorageï¼Œä¾›index.htmlè¯»å–
            sessionStorage.setItem('previewConfig', JSON.stringify(config));
            window.open('index.html', '_blank');
        }

        // ==================== æ˜¾ç¤ºé€šçŸ¥ ====================
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // ==================== å¯åŠ¨åº”ç”¨ ====================
        init();
    </script>
</body>
</html>
