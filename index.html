<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°å­¦æ‚è´§åº— v0.3.0 - Math Grocery</title>
    <style>
        /* ==================== å…¨å±€æ ·å¼ ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow: hidden;
        }

        /* ==================== æ¸¸æˆå®¹å™¨ ==================== */
        .game-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: white;
        }

        /* ==================== é¡¾å®¢åŒºåŸŸ (ä¸Šæ–¹ 25vh) ==================== */
        .customer-area {
            height: 25vh;
            background: linear-gradient(180deg, #e3f2fd 0%, #bbdefb 100%);
            border-bottom: 3px solid #1976d2;
            padding: 15px 30px;
            position: relative;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 10px;
        }

        .customer-avatar {
            width: 120px;
            height: 160px;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.2));
            margin-bottom: 0;
            animation: customerEnter 0.5s ease-out;
            position: relative;
            display: inline-block;
            border-radius: 10px;
            margin-right: 30vw;
        }

        .customer-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 10px;
            object-fit: cover;
            object-position: top center;
        }

        @keyframes customerEnter {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .customer-dialog {
            position: absolute;
            left: 100%;
            top: -20px;
            margin-left: 30px;
            min-width: 350px;
            max-width: 550px;
            background: white;
            border-radius: 15px;
            padding: 15px 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            text-align: left;
            animation: dialogBounce 0.5s ease-out 0.2s both;
            z-index: 10;
        }

        @keyframes dialogBounce {
            0% {
                opacity: 0;
                transform: scale(0.8) translateY(-10px);
            }
            60% {
                transform: scale(1.05) translateY(0);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .customer-dialog::before {
            content: '';
            position: absolute;
            left: -10px;
            top: 30px;
            width: 0;
            height: 0;
            border-top: 10px solid transparent;
            border-bottom: 10px solid transparent;
            border-right: 10px solid white;
        }

        .dialog-text {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .customer-order {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            letter-spacing: 4px;
        }

        .customer-bag {
            position: absolute;
            right: 15px;
            bottom: 15px;
            min-width: 150px;
            background: #fff3cd;
            border-radius: 10px;
            padding: 10px;
            border: 2px dashed #ffa726;
            transition: all 0.3s ease;
        }

        .customer-bag.shake {
            animation: bagShake 0.5s ease;
        }

        @keyframes bagShake {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-5deg) scale(1.05); }
            75% { transform: rotate(5deg) scale(1.05); }
        }

        .bag-title {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .bag-items {
            font-size: 24px;
            min-height: 30px;
        }

        .payment-info {
            text-align: center;
            margin-top: 10px;
        }

        .payment-amount {
            font-size: 18px;
            font-weight: bold;
            color: #d32f2f;
        }

        /* ==================== è´§æ¶+æ“ä½œåŒºåŸŸ (ä¸‹æ–¹ 75vh) ==================== */
        .main-area {
            height: 75vh;
            display: flex;
            position: relative;
            background: #f5f5f5;
        }

        /* ==================== è´§æ¶å®¹å™¨ ==================== */
        .shelf-container {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        /* è´§æ¶åŒºåŸŸåŸºç¡€æ ·å¼ */
        .shelf-area {
            position: absolute;
            border: 2px solid #999;
            border-radius: 8px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            animation: shelfFadeIn 0.5s ease-out both;
        }

        @keyframes shelfFadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* è´§æ¶ç±»å‹ï¼šå‚ç›´å¡”å¼ */
        .shelf-area-tower {
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            background: linear-gradient(180deg, #fff9c4 0%, #fff59d 100%);
        }

        /* è´§æ¶ç±»å‹ï¼šç½‘æ ¼ */
        .shelf-area-grid {
            display: grid;
            gap: 8px;
            background: linear-gradient(135deg, #fce4ec 0%, #f8bbd0 100%);
        }

        /* è´§æ¶ç±»å‹ï¼šåˆ†å±‚å±•ç¤º */
        .shelf-area-shelves {
            display: flex;
            flex-direction: column;
            justify-content: space-evenly;
            background: linear-gradient(180deg, #e8f5e9 0%, #c8e6c9 100%);
        }

        .shelf-row {
            display: flex;
            gap: 10px;
            justify-content: center;
            padding: 5px 0;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .shelf-row:last-child {
            border-bottom: none;
        }

        /* è´§æ¶ç±»å‹ï¼šå†°æŸœ */
        .shelf-area-freezer {
            background: linear-gradient(135deg, #e1f5fe 0%, #b3e5fc 100%);
            border: 3px solid #0277bd;
            display: flex;
            flex-wrap: wrap;
            align-content: flex-start;
            gap: 8px;
            padding: 15px;
        }

        .freezer-label {
            position: absolute;
            top: -12px;
            right: 10px;
            background: #0277bd;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        /* ä»·æ ¼æ ‡ç­¾ */
        .price-label {
            position: absolute;
            top: -10px;
            left: 10px;
            background: #fff;
            border: 2px solid #ffa726;
            border-radius: 8px;
            padding: 6px 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            font-size: 11px;
            line-height: 1.3;
            z-index: 1;
            max-width: calc(100% - 20px);
        }

        .price-label-header {
            font-weight: bold;
            color: #333;
            margin-bottom: 2px;
        }

        .price-label-items {
            color: #666;
        }

        .price-label-item {
            display: flex;
            justify-content: space-between;
            gap: 8px;
        }

        .price-label-discount {
            color: #d32f2f;
            font-weight: bold;
            margin-top: 2px;
            font-size: 10px;
        }

        /* å•†å“å¡ç‰‡ */
        .product-item {
            cursor: pointer;
            text-align: center;
            padding: 8px;
            background: white;
            border-radius: 8px;
            border: 2px solid #ddd;
            transition: all 0.2s;
            user-select: none;
        }

        .product-item:hover:not(.picked) {
            transform: scale(1.05);
            border-color: #667eea;
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
        }

        .product-item:active:not(.picked) {
            transform: scale(0.98);
        }

        .product-item.picked {
            opacity: 0.3;
            cursor: not-allowed;
            border-color: #ccc;
            animation: pickAnimation 0.4s ease;
        }

        @keyframes pickAnimation {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.2) rotate(5deg);
                opacity: 0.8;
            }
            100% {
                transform: scale(1);
                opacity: 0.3;
            }
        }

        .product-emoji {
            font-size: 32px;
            margin-bottom: 4px;
        }

        /* Emoji å°ºå¯¸å˜ä½“ */
        .product-emoji.emoji-small {
            font-size: 24px;
        }

        .product-emoji.emoji-medium {
            font-size: 32px;
        }

        .product-emoji.emoji-large {
            font-size: 40px;
        }

        /* ç”¨äºè®¢å•å’Œè´­ç‰©è¢‹ä¸­çš„ emoji å°ºå¯¸ */
        .emoji-small {
            font-size: 24px;
        }

        .emoji-medium {
            font-size: 32px;
        }

        .emoji-large {
            font-size: 40px;
        }

        .product-name {
            font-size: 12px;
            color: #666;
        }

        /* ==================== è®¡ç®—å™¨åŒºåŸŸ ==================== */
        .cashier-area {
            position: absolute;
            left: 50%;
            top: 5%;
            transform: translateX(-50%);
            width: 600px;
            max-width: 90%;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            z-index: 50;
        }

        /* è®¡ç®—å™¨æç¤ºæ–‡å­— */
        .calculator-hint {
            text-align: center;
            color: white;
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 15px;
            opacity: 0.9;
            letter-spacing: 1px;
        }

        /* æ˜¾ç¤ºå±å’Œé€å‡ºæŒ‰é’®å®¹å™¨ */
        .display-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 30px;
        }

        /* è®¡ç®—å™¨æ˜¾ç¤ºå±ï¼ˆç¼©çŸ­ï¼‰ */
        .calculator-display {
            flex: 1;
            background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%);
            border-radius: 15px;
            padding: 25px 20px;
            min-height: 90px;
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.2);
        }

        .calculator-question {
            font-size: 32px;
            font-weight: bold;
            color: #1a1a1a;
            text-align: center;
            letter-spacing: 3px;
        }

        /* é€å‡ºæŒ‰é’®ï¼ˆåœ¨æ˜¾ç¤ºå±å³ä¾§ï¼‰ */
        .btn-submit-top {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            border: none;
            font-size: 48px;
            color: white;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4);
            flex-shrink: 0;
        }

        .btn-submit-top:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.6);
        }

        .btn-submit-top:active {
            transform: scale(0.95);
        }

        .calculator-buttons {
            position: relative;
            height: 450px;
            width: 100%;
        }

        .calc-button {
            position: absolute;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: none;
            font-size: 32px;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
        }

        /* ç­‰å¼è®°å½•å™¨æŒ‰é’®å¸ƒå±€ */
        /* ç¬¬1æ’ï¼š1 2 3 4 */
        .btn-1 { left: 90px; top: 30px; }
        .btn-2 { left: 190px; top: 30px; }
        .btn-3 { left: 290px; top: 30px; }
        .btn-4 { left: 390px; top: 30px; }

        /* ç¬¬2æ’ï¼š5 6 7 */
        .btn-5 { left: 140px; top: 130px; }
        .btn-6 { left: 240px; top: 130px; }
        .btn-7 { left: 340px; top: 130px; }

        /* ç¬¬3æ’ï¼š8 9 */
        .btn-8 { left: 190px; top: 230px; }
        .btn-9 { left: 290px; top: 230px; }

        /* ç¬¬4æ’ï¼š0 Backspace */
        .btn-0 { left: 240px; top: 330px; }
        .btn-backspace {
            left: 340px;
            top: 330px;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            font-size: 36px;
        }

        .calc-button:hover {
            transform: scale(1.1);
        }

        .calculator-operators {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .calc-op-button {
            width: 80px;
            height: 60px;
            border-radius: 12px;
            border: none;
            font-size: 28px;
            font-weight: bold;
            color: white;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            cursor: pointer;
            transition: all 0.2s;
        }

        .calc-op-button:hover {
            transform: scale(1.1);
        }

        /* Keep some existing styles for backward compatibility */
        .btn-group {
            display: flex;
            gap: 10px;
        }

        .btn {
            flex: 1;
            padding: 12px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #667eea;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn-primary:hover:not(:disabled)::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary:hover:not(:disabled) {
            background: #5568d3;
        }

        .btn-secondary {
            background: #ff7675;
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #d63031;
        }

        .btn-success {
            background: #00b894;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .btn-success::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn-success:hover:not(:disabled)::before {
            width: 300px;
            height: 300px;
        }

        .btn-success:hover:not(:disabled) {
            background: #00a383;
        }

        /* ==================== åé¦ˆåŒºåŸŸ ==================== */
        .feedback-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .feedback-overlay.show {
            display: flex;
        }

        .feedback-box {
            background: white;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            max-width: 400px;
            animation: feedbackBounce 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes feedbackBounce {
            0% {
                transform: scale(0.3) rotate(-10deg);
                opacity: 0;
            }
            70% {
                transform: scale(1.05) rotate(2deg);
            }
            100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        .feedback-emoji {
            font-size: 80px;
            margin-bottom: 20px;
            animation: emojiPop 0.6s ease 0.3s both;
        }

        @keyframes emojiPop {
            0% {
                transform: scale(0);
                opacity: 0;
            }
            50% {
                transform: scale(1.3) rotate(10deg);
            }
            100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        .feedback-text {
            font-size: 20px;
            color: #333;
            margin-bottom: 30px;
            white-space: pre-line;
        }

        /* ==================== éšè—å…ƒç´  ==================== */
        .hidden {
            display: none !important;
        }

        /* ==================== å“åº”å¼è®¾è®¡ ==================== */
        @media (max-width: 768px) {
            .customer-area {
                padding: 10px 15px;
            }

            .customer-avatar {
                font-size: 60px;
            }

            .customer-bag {
                right: 15px;
                min-width: 120px;
            }

            .dialog-text {
                font-size: 14px;
            }

            .customer-order {
                font-size: 16px;
            }

            .cashier-area {
                width: 95vw;
                padding: 15px;
            }

            .cash-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .product-emoji {
                font-size: 24px;
            }

            .product-name {
                font-size: 10px;
            }

            .product-price {
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- ==================== é¡¾å®¢åŒºåŸŸ ==================== -->
        <div class="customer-area">
            <div class="customer-avatar" id="customerAvatar">
                <img id="customerImage" src="" alt="Customer">
                <div class="customer-dialog">
                    <div class="dialog-text" id="dialogText">Welcome to Math Grocery!</div>
                    <div class="customer-order" id="customerOrder"></div>
                    <div class="payment-info hidden" id="paymentInfo">
                        <span class="payment-amount" id="paymentAmount"></span>
                    </div>
                </div>
            </div>

            <!-- è´­ç‰©è¢‹æ”¾åœ¨å³ä¸Šè§’ -->
            <div class="customer-bag">
                <div class="bag-title">Customer's Bag</div>
                <div class="bag-items" id="bagItems">-</div>
            </div>
        </div>

        <!-- ==================== è´§æ¶+æ“ä½œåŒºåŸŸ ==================== -->
        <div class="main-area">
            <!-- è´§æ¶å®¹å™¨ï¼ˆåŠ¨æ€ç”Ÿæˆï¼‰ -->
            <div class="shelf-container" id="shelfContainer"></div>

            <!-- è®¡ç®—å™¨åŒºåŸŸ -->
            <div class="cashier-area" id="cashierArea">
                <!-- æç¤ºæ–‡å­— -->
                <div class="calculator-hint">Enter equation or result (e.g., 10-7.5=2.5 or 2.5)</div>

                <!-- æ˜¾ç¤ºå±å’Œé€å‡ºæŒ‰é’® -->
                <div class="display-container">
                    <!-- æ˜¾ç¤ºå± -->
                    <div class="calculator-display">
                        <div class="calculator-question" id="calculatorQuestion">0</div>
                    </div>

                    <!-- é€å‡ºæŒ‰é’® -->
                    <button class="btn-submit-top" onclick="submitChange()">â¬†ï¸</button>
                </div>

                <!-- æ•°å­—æŒ‰é’®ï¼ˆç­‰å¼è®°å½•å™¨å¸ƒå±€ï¼‰ -->
                <div class="calculator-buttons">
                    <!-- ç¬¬1æ’ï¼š1 2 3 4 -->
                    <button class="calc-button btn-1" onclick="inputDigit('1')">1</button>
                    <button class="calc-button btn-2" onclick="inputDigit('2')">2</button>
                    <button class="calc-button btn-3" onclick="inputDigit('3')">3</button>
                    <button class="calc-button btn-4" onclick="inputDigit('4')">4</button>

                    <!-- ç¬¬2æ’ï¼š5 6 7 -->
                    <button class="calc-button btn-5" onclick="inputDigit('5')">5</button>
                    <button class="calc-button btn-6" onclick="inputDigit('6')">6</button>
                    <button class="calc-button btn-7" onclick="inputDigit('7')">7</button>

                    <!-- ç¬¬3æ’ï¼š8 9 -->
                    <button class="calc-button btn-8" onclick="inputDigit('8')">8</button>
                    <button class="calc-button btn-9" onclick="inputDigit('9')">9</button>

                    <!-- ç¬¬4æ’ï¼š0 ğŸ”™ -->
                    <button class="calc-button btn-0" onclick="inputDigit('0')">0</button>
                    <button class="calc-button btn-backspace" onclick="backspace()">ğŸ”™</button>
                </div>

                <!-- æ“ä½œæŒ‰é’® -->
                <div class="calculator-operators">
                    <button class="calc-op-button" onclick="inputSymbol('+')">+</button>
                    <button class="calc-op-button" onclick="inputSymbol('-')">-</button>
                    <button class="calc-op-button" onclick="inputSymbol('Ã—')">Ã—</button>
                    <button class="calc-op-button" onclick="inputSymbol('Ã·')">Ã·</button>
                    <button class="calc-op-button" onclick="inputSymbol('=')">=</button>
                    <button class="calc-op-button" onclick="inputSymbol('.')">.</button>
                </div>
            </div>
        </div>

        <!-- ==================== åé¦ˆè¦†ç›–å±‚ ==================== -->
        <div class="feedback-overlay" id="feedbackOverlay">
            <div class="feedback-box">
                <div class="feedback-emoji" id="feedbackEmoji">ğŸ˜Š</div>
                <div class="feedback-text" id="feedbackText">Result text</div>
                <button class="btn btn-success" onclick="nextCustomer()">Next Customer</button>
            </div>
        </div>
    </div>

    <script>
        /**
         * ==================== æ¸¸æˆæ•°æ®é…ç½® ====================
         */

        /**
         * é…ç½®åŠ è½½ç³»ç»Ÿï¼šä¼˜å…ˆä»å¤–éƒ¨JSONåŠ è½½ï¼Œå¤±è´¥åˆ™ä½¿ç”¨å†…åµŒé»˜è®¤é…ç½®
         */
        let PRODUCTS = {};
        let SHELF_CONFIG = [];
        let cashRegister = {};
        let customerAreaConfig = {};
        let calculatorConfig = {};
        let DISCOUNT_RULES = []; // æŠ˜æ‰£è§„åˆ™æ•°ç»„

        /**
         * åº”ç”¨é¡¾å®¢åŒºåŸŸæ ·å¼é…ç½®
         */
        function applyCustomerAreaStyles(config) {
            if (!config || !config.avatar) return;

            const avatar = document.querySelector('.customer-avatar');
            const dialog = document.querySelector('.customer-dialog');

            if (config.avatar.width) avatar.style.width = config.avatar.width;
            if (config.avatar.height) avatar.style.height = config.avatar.height;
            if (config.avatar.borderRadius) {
                avatar.style.borderRadius = config.avatar.borderRadius;
                const img = avatar.querySelector('img');
                if (img) img.style.borderRadius = config.avatar.borderRadius;
            }
            if (config.avatar.marginRight) avatar.style.marginRight = config.avatar.marginRight;

            if (config.dialog) {
                if (config.dialog.minWidth) dialog.style.minWidth = config.dialog.minWidth;
                if (config.dialog.maxWidth) dialog.style.maxWidth = config.dialog.maxWidth;
                if (config.dialog.marginLeft) dialog.style.marginLeft = config.dialog.marginLeft;
            }
        }

        /**
         * åº”ç”¨è®¡ç®—å™¨æ ·å¼é…ç½®
         */
        function applyCalculatorStyles(config) {
            if (!config) return;

            const cashierArea = document.querySelector('.cashier-area');
            const display = document.querySelector('.calculator-display');
            const submitButton = document.querySelector('.btn-submit-top');
            const operators = document.querySelector('.calculator-operators');

            // åº”ç”¨è®¡ç®—å™¨æ•´ä½“æ ·å¼
            if (config.position) {
                if (config.position.left) cashierArea.style.left = config.position.left;
                if (config.position.top) cashierArea.style.top = config.position.top;
            }
            if (config.size) {
                if (config.size.width) cashierArea.style.width = config.size.width;
                if (config.size.maxWidth) cashierArea.style.maxWidth = config.size.maxWidth;
            }
            if (config.padding) cashierArea.style.padding = config.padding;

            // åº”ç”¨æ˜¾ç¤ºå±æ ·å¼
            if (config.display && display) {
                if (config.display.height) display.style.minHeight = config.display.height;
                if (config.display.padding) display.style.padding = config.display.padding;
            }

            // åº”ç”¨é€å‡ºæŒ‰é’®æ ·å¼
            if (config.submitButton && submitButton) {
                if (config.submitButton.width) submitButton.style.width = config.submitButton.width;
                if (config.submitButton.height) submitButton.style.height = config.submitButton.height;
                if (config.submitButton.fontSize) submitButton.style.fontSize = config.submitButton.fontSize;
            }

            // åº”ç”¨æ•°å­—æŒ‰é’®æ ·å¼
            if (config.numberButtons) {
                const numberButtons = document.querySelectorAll('.calc-button');
                numberButtons.forEach(button => {
                    if (config.numberButtons.width) button.style.width = config.numberButtons.width;
                    if (config.numberButtons.height) button.style.height = config.numberButtons.height;
                    if (config.numberButtons.fontSize) button.style.fontSize = config.numberButtons.fontSize;
                });

                // åº”ç”¨æŒ‰é’®ä½ç½®
                if (config.numberButtons.positions) {
                    Object.keys(config.numberButtons.positions).forEach(key => {
                        const pos = config.numberButtons.positions[key];
                        const btnClass = key === 'backspace' ? '.btn-backspace' : `.btn-${key}`;
                        const btn = document.querySelector(btnClass);
                        if (btn && pos) {
                            if (pos.left) btn.style.left = pos.left;
                            if (pos.top) btn.style.top = pos.top;
                        }
                    });
                }
            }

            // åº”ç”¨æ“ä½œç¬¦æŒ‰é’®æ ·å¼
            if (config.operatorButtons && operators) {
                if (config.operatorButtons.gap) operators.style.gap = config.operatorButtons.gap;
                const opButtons = operators.querySelectorAll('.calc-op-button');
                opButtons.forEach(button => {
                    if (config.operatorButtons.width) button.style.width = config.operatorButtons.width;
                    if (config.operatorButtons.height) button.style.height = config.operatorButtons.height;
                    if (config.operatorButtons.fontSize) button.style.fontSize = config.operatorButtons.fontSize;
                });
            }
        }

        /**
         * ä»å¤–éƒ¨JSONæ–‡ä»¶åŠ è½½é…ç½®
         */
        async function loadConfig() {
            try {
                const response = await fetch('game-config.json');
                if (!response.ok) throw new Error('Config file not found');

                const config = await response.json();
                console.log('âœ… å¤–éƒ¨é…ç½®æ–‡ä»¶åŠ è½½æˆåŠŸ (game-config.json)');

                PRODUCTS = config.products;
                SHELF_CONFIG = config.shelves;
                cashRegister = config.cashRegister;
                customerAreaConfig = config.customerArea || {};
                calculatorConfig = config.calculator || {};

                // æ”¶é›†æ‰€æœ‰è´§æ¶çš„æŠ˜æ‰£è§„åˆ™
                DISCOUNT_RULES = [];
                config.shelves.forEach(shelf => {
                    if (shelf.discountRules) {
                        DISCOUNT_RULES.push(...shelf.discountRules);
                    }
                });

                // åº”ç”¨é¡¾å®¢åŒºåŸŸæ ·å¼
                applyCustomerAreaStyles(customerAreaConfig);

                // åº”ç”¨è®¡ç®—å™¨æ ·å¼
                applyCalculatorStyles(calculatorConfig);

                return true;
            } catch (error) {
                console.warn('âš ï¸ æ— æ³•åŠ è½½å¤–éƒ¨é…ç½®æ–‡ä»¶ï¼Œä½¿ç”¨å†…åµŒé»˜è®¤é…ç½®');
                console.error('é”™è¯¯è¯¦æƒ…:', error);
                loadDefaultConfig();
                return false;
            }
        }

        /**
         * åŠ è½½å†…åµŒçš„é»˜è®¤é…ç½®ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
         */
        function loadDefaultConfig() {
            console.log('ğŸ“¦ ä½¿ç”¨å†…åµŒé»˜è®¤é…ç½®');

            customerAreaConfig = {
                height: "25vh",
                background: "linear-gradient(180deg, #e3f2fd 0%, #bbdefb 100%)",
                avatar: {
                    width: "120px",
                    height: "160px",
                    borderRadius: "10px",
                    marginRight: "30vw"
                },
                dialog: {
                    minWidth: "350px",
                    maxWidth: "550px",
                    marginLeft: "30px"
                }
            };

            calculatorConfig = {
                position: {
                    left: "50%",
                    top: "5%"
                },
                size: {
                    width: "600px",
                    maxWidth: "90%"
                },
                padding: "30px",
                display: {
                    height: "90px",
                    padding: "25px 20px"
                },
                submitButton: {
                    width: "90px",
                    height: "90px",
                    fontSize: "48px"
                },
                numberButtons: {
                    width: "70px",
                    height: "70px",
                    fontSize: "32px",
                    positions: {
                        "1": { left: "90px", top: "30px" },
                        "2": { left: "190px", top: "30px" },
                        "3": { left: "290px", top: "30px" },
                        "4": { left: "390px", top: "30px" },
                        "5": { left: "140px", top: "130px" },
                        "6": { left: "240px", top: "130px" },
                        "7": { left: "340px", top: "130px" },
                        "8": { left: "190px", top: "230px" },
                        "9": { left: "290px", top: "230px" },
                        "0": { left: "240px", top: "330px" },
                        "backspace": { left: "340px", top: "330px" }
                    }
                },
                operatorButtons: {
                    width: "80px",
                    height: "60px",
                    fontSize: "28px",
                    gap: "15px"
                }
            };

            PRODUCTS = {
                lollipop: { name: "Lollipop", emoji: "ğŸ­", price: 0.50 },
                apple: { name: "Apple", emoji: "ğŸ", price: 1.00 },
                donut_a: { name: "Donut A", emoji: "ğŸ©", price: 2.50, emojiSize: "small" },
                donut_b: { name: "Donut B", emoji: "ğŸ©", price: 2.55, emojiSize: "medium" },
                donut_c: { name: "Donut C", emoji: "ğŸ©", price: 2.75, emojiSize: "large" },
                chips: { name: "Chips", emoji: "ğŸŸ", price: 1.20 },
                orange: { name: "Orange", emoji: "ğŸŠ", price: 3.00 },
                milk: { name: "Milk", emoji: "ğŸ¥›", price: 1.50 },
                meat: { name: "Beef", emoji: "ğŸ¥©", price: 15.00 },
                fish: { name: "Fish", emoji: "ğŸŸ", price: 15.00 },
                chicken: { name: "Chicken Leg", emoji: "ğŸ—", price: 15.00 }
            };

            SHELF_CONFIG = [
            // Donut Shelf - 3x3 Grid (C/B/A rows, 3 per row)
            {
                id: 'donut-shelf',
                name: 'Donut Shelf',
                type: 'grid',
                position: { left: '0', top: '5vh' },
                size: { width: '220px', height: '35vh' },
                layout: 'grid',
                gridConfig: { rows: 3, cols: 3 },
                products: [
                    'donut_c', 'donut_c', 'donut_c',
                    'donut_b', 'donut_b', 'donut_b',
                    'donut_a', 'donut_a', 'donut_a'
                ],
                style: 'shelf-area-grid',
                showProductName: false,
                priceLabel: {
                    show: true,
                    productName: 'Donuts',
                    items: [
                        { name: 'å¤§ (Large)', price: '$2.75' },
                        { name: 'ä¸­ (Medium)', price: '$2.55' },
                        { name: 'å° (Small)', price: '$2.50' }
                    ],
                    unit: 'each',
                    discount: null
                }
            },
            {
                id: 'snack-corner',
                name: 'Snack Corner',
                type: 'grid',
                position: { left: '0', bottom: '0' },
                size: { width: '200px', height: '28vh' },
                layout: 'grid',
                gridConfig: { rows: 2, cols: 3 },
                products: ['lollipop', 'lollipop', 'lollipop', 'chips', 'chips', 'chips'],
                style: 'shelf-area-grid',
                showProductName: false,
                discountRules: [
                    { productId: 'lollipop', quantity: 2, price: 0.70 }
                ],
                priceLabel: {
                    show: true,
                    productName: 'Snacks',
                    items: [
                        { name: 'Lollipop', price: '$0.50' },
                        { name: 'Chips', price: '$1.20' }
                    ],
                    unit: 'each',
                    discount: '2 Lollipops for $0.70'
                }
            },
            {
                id: 'fruit-stand',
                name: 'Fruit Stand',
                type: 'shelves',
                position: { left: '250px', top: '20vh' },
                size: { width: '180px', height: '35vh' },
                layout: 'rows',
                products: [
                    { row: 'top', items: ['apple', 'apple'] },
                    { row: 'middle', items: ['apple', 'apple', 'apple'] },
                    { row: 'bottom', items: [] }
                ],
                style: 'shelf-area-shelves',
                showProductName: false,
                priceLabel: {
                    show: true,
                    productName: 'Fresh Produce',
                    items: [
                        { name: 'Apple', price: '$1.00' }
                    ],
                    unit: 'each',
                    discount: null
                }
            },
            {
                id: 'seafood-freezer',
                name: 'Seafood Freezer',
                type: 'freezer',
                position: { right: '20px', top: '15vh' },
                size: { width: '220px', height: '22vh' },
                layout: 'scattered',
                products: ['fish', 'fish', 'fish'],
                style: 'shelf-area-freezer',
                showProductName: false,
                priceLabel: {
                    show: true,
                    productName: 'Fish',
                    price: '$15.00',
                    unit: 'each',
                    discount: null
                }
            },
            {
                id: 'meat-freezer',
                name: 'Meat Freezer',
                type: 'freezer',
                position: { right: '20px', top: '42vh' },
                size: { width: '220px', height: '30vh' },
                layout: 'mixed',
                products: ['meat', 'chicken', 'chicken', 'chicken', 'chicken'],
                style: 'shelf-area-freezer',
                showProductName: false,
                priceLabel: {
                    show: true,
                    productName: 'Meat',
                    items: [
                        { name: 'Beef', price: '$15.00' },
                        { name: 'Chicken', price: '$15.00' }
                    ],
                    unit: 'each',
                    discount: null
                }
            }
        ];

            cashRegister = {
                '0.05': 10,  '0.10': 10,  '0.20': 10,  '0.50': 10,
                '1': 20,     '2': 10,     '5': 10,     '10': 10,  '50': 5
            };

            // æ”¶é›†æ‰€æœ‰è´§æ¶çš„æŠ˜æ‰£è§„åˆ™
            DISCOUNT_RULES = [];
            SHELF_CONFIG.forEach(shelf => {
                if (shelf.discountRules) {
                    DISCOUNT_RULES.push(...shelf.discountRules);
                }
            });

            // åº”ç”¨é¡¾å®¢åŒºåŸŸæ ·å¼
            applyCustomerAreaStyles(customerAreaConfig);

            // åº”ç”¨è®¡ç®—å™¨æ ·å¼
            applyCalculatorStyles(calculatorConfig);
        }

        /**
         * æ¸¸æˆçŠ¶æ€ç®¡ç†
         */
        let gameState = {
            phase: 'order_received',  // order_received, picking_items, making_change, result
            currentCustomer: {
                order: [],           // [{ productId, quantity }, ...]
                bag: [],             // å·²ç»™çš„å•†å“ [itemId, itemId, ...]
                totalPrice: 0,
                paid: 0,
                correctChange: 0
            },
            selectedCoins: {},       // ç©å®¶é€‰æ‹©çš„å¸é¢ { '0.05': 2, '1': 1, ... }
            selectedAmount: 0,
            score: 0,
            itemIdCounter: 0         // å•†å“å®ä¾‹IDè®¡æ•°å™¨
        };

        /**
         * ==================== ç­‰å¼è®°å½•å™¨é€»è¾‘ ====================
         */
        let equationDisplay = '';

        /**
         * æ›´æ–°æ˜¾ç¤ºå±
         */
        function updateEquationDisplay() {
            const display = document.getElementById('calculatorQuestion');
            display.textContent = equationDisplay || '0';
        }

        /**
         * è¾“å…¥æ•°å­—
         */
        function inputDigit(digit) {
            equationDisplay += digit;
            updateEquationDisplay();
        }

        /**
         * è¾“å…¥ç¬¦å·
         */
        function inputSymbol(symbol) {
            equationDisplay += symbol;
            updateEquationDisplay();
        }

        /**
         * é€€æ ¼åˆ é™¤
         */
        function backspace() {
            if (equationDisplay.length > 0) {
                equationDisplay = equationDisplay.slice(0, -1);
                updateEquationDisplay();
            }
        }

        /**
         * æå–æ‰¾é›¶é‡‘é¢ï¼ˆæ”¯æŒç­‰å¼æˆ–ç›´æ¥æ•°å­—ï¼‰
         */
        function extractChangeAmount() {
            const input = equationDisplay.trim();

            if (!input) {
                return null;
            }

            // æŸ¥æ‰¾ç­‰å·ä½ç½®
            const equalIndex = input.lastIndexOf('=');

            if (equalIndex !== -1) {
                // æœ‰ç­‰å·ï¼Œæå–ç­‰å·å³è¾¹çš„éƒ¨åˆ†
                if (equalIndex === input.length - 1) {
                    return null; // ç­‰å·åé¢æ²¡æœ‰å†…å®¹
                }
                const rightSide = input.substring(equalIndex + 1).trim();
                const amount = parseFloat(rightSide);
                return isNaN(amount) ? null : amount;
            } else {
                // æ²¡æœ‰ç­‰å·ï¼Œç›´æ¥å°è¯•å°†æ•´ä¸ªè¾“å…¥è½¬æ¢ä¸ºæ•°å­—
                const amount = parseFloat(input);
                return isNaN(amount) ? null : amount;
            }
        }

        /**
         * æäº¤æ‰¾é›¶ï¼ˆçº¢è‰²â¬†ï¸æŒ‰é’®ï¼‰
         */
        function submitChange() {
            const changeAmount = extractChangeAmount();

            if (changeAmount === null) {
                showTempMessage('Please enter a valid number or equation! (e.g., 2.5 or 10-7.5=2.5)', 'warning');
                return;
            }

            // éªŒè¯æ‰¾é›¶æ˜¯å¦æ­£ç¡®
            const correctChange = gameState.currentCustomer.correctChange;
            const isCorrect = Math.abs(changeAmount - correctChange) < 0.01;

            if (isCorrect) {
                // æ‰¾é›¶æ­£ç¡®
                showResultFeedback(true, changeAmount);
                gameState.score++;
            } else {
                // æ‰¾é›¶é”™è¯¯
                showResultFeedback(false, changeAmount);
            }

            // æ¸…ç©ºç­‰å¼
            equationDisplay = '';
            updateEquationDisplay();

            // å»¶è¿Ÿè¿›å…¥ä¸‹ä¸€ä¸ªé¡¾å®¢
            setTimeout(() => {
                hideResultFeedback();
                nextCustomer();
            }, 2500);
        }

        /**
         * æ˜¾ç¤ºç»“æœåé¦ˆ
         */
        function showResultFeedback(isCorrect, playerChange) {
            const overlay = document.getElementById('feedbackOverlay');
            const correctChange = gameState.currentCustomer.correctChange;

            overlay.innerHTML = `
                <div class="feedback-box" style="animation: feedbackBounce 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) both;">
                    <div class="feedback-emoji" style="animation: emojiPop 0.6s ease 0.3s both;">
                        ${isCorrect ? 'ğŸ˜Š' : 'ğŸ˜¢'}
                    </div>
                    <div class="feedback-title" style="font-size: 28px; font-weight: bold; margin: 20px 0; color: #333;">
                        ${isCorrect ? 'Correct!' : 'Incorrect!'}
                    </div>
                    <div class="feedback-details" style="font-size: 18px; color: #666; line-height: 1.6;">
                        <div>Your change: <strong>$${playerChange.toFixed(2)}</strong></div>
                        <div>Correct change: <strong>$${correctChange.toFixed(2)}</strong></div>
                        <div style="margin-top: 15px;">Score: <strong>${gameState.score}</strong></div>
                    </div>
                </div>
            `;

            overlay.style.display = 'flex';
        }

        /**
         * éšè—ç»“æœåé¦ˆ
         */
        function hideResultFeedback() {
            const overlay = document.getElementById('feedbackOverlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }

        /**
         * ==================== è´§æ¶æ¸²æŸ“ç³»ç»Ÿ ====================
         */

        /**
         * åˆå§‹åŒ–æ‰€æœ‰è´§æ¶åŒºåŸŸ
         */
        function initShelfAreas() {
            const container = document.getElementById('shelfContainer');
            container.innerHTML = '';
            gameState.itemIdCounter = 0;  // é‡ç½®IDè®¡æ•°å™¨

            SHELF_CONFIG.forEach(config => {
                const areaEl = renderShelfArea(config);
                container.appendChild(areaEl);
            });
        }

        /**
         * æ ¹æ®é…ç½®æ¸²æŸ“å•ä¸ªè´§æ¶åŒºåŸŸ
         */
        function renderShelfArea(config) {
            const div = document.createElement('div');
            div.id = config.id;
            div.className = `shelf-area ${config.style}`;

            // è®¾ç½®ä½ç½®å’Œå°ºå¯¸
            div.style.cssText = `
                ${config.position.left !== undefined ? `left: ${config.position.left};` : ''}
                ${config.position.right !== undefined ? `right: ${config.position.right};` : ''}
                ${config.position.top !== undefined ? `top: ${config.position.top};` : ''}
                ${config.position.bottom !== undefined ? `bottom: ${config.position.bottom};` : ''}
                width: ${config.size.width};
                height: ${config.size.height};
            `;

            // æ·»åŠ ä»·æ ¼æ ‡ç­¾ï¼ˆå¦‚æœæœ‰ï¼‰
            if (config.priceLabel && config.priceLabel.show) {
                const priceLabel = document.createElement('div');
                priceLabel.className = 'price-label';

                // ç®€å•ä»·æ ¼æ ‡ç­¾ï¼ˆç”œç”œåœˆè´§æ¶ç”¨ï¼‰
                if (config.priceLabel.price && !config.priceLabel.productName) {
                    priceLabel.innerHTML = config.priceLabel.price;
                    priceLabel.style.fontSize = '16px';
                    priceLabel.style.fontWeight = 'bold';
                } else {
                    // å¤æ‚ä»·æ ¼æ ‡ç­¾ï¼ˆåŸæœ‰æ ¼å¼ï¼‰
                    let labelHTML = `<div class="price-label-header">${config.priceLabel.productName || ''}</div>`;
                    labelHTML += `<div class="price-label-items">`;

                    // å¤„ç†å¤šç§ä»·æ ¼æ˜¾ç¤ºæ ¼å¼
                    if (config.priceLabel.items) {
                        // å¤šå•†å“åˆ—è¡¨æ ¼å¼
                        config.priceLabel.items.forEach(item => {
                            labelHTML += `<div class="price-label-item"><span>${item.name}</span><span>${item.price}</span></div>`;
                        });
                    } else if (config.priceLabel.prices) {
                        // å¤šä»·æ ¼æ•°ç»„æ ¼å¼ï¼ˆå¦‚ç”œç”œåœˆï¼‰
                        labelHTML += config.priceLabel.prices.join(', ') + ' ' + (config.priceLabel.unit || '');
                    } else if (config.priceLabel.price) {
                        // å•ä¸€ä»·æ ¼æ ¼å¼
                        labelHTML += config.priceLabel.price + ' ' + (config.priceLabel.unit || '');
                    }

                    labelHTML += `</div>`;

                    // æ·»åŠ æŠ˜æ‰£ä¿¡æ¯
                    if (config.priceLabel.discount) {
                        labelHTML += `<div class="price-label-discount">ğŸ·ï¸ ${config.priceLabel.discount}</div>`;
                    }

                    priceLabel.innerHTML = labelHTML;
                }

                div.appendChild(priceLabel);
            }

            // æ ¹æ®å¸ƒå±€ç±»å‹æ¸²æŸ“å•†å“
            renderProducts(div, config.products, config.layout, config.gridConfig, config.showProductName);

            return div;
        }

        /**
         * æ ¹æ®å¸ƒå±€ç±»å‹æ¸²æŸ“å•†å“
         */
        function renderProducts(container, products, layout, gridConfig, showProductName = false) {
            if (layout === 'grid' && gridConfig) {
                container.style.gridTemplateRows = `repeat(${gridConfig.rows}, 1fr)`;
                container.style.gridTemplateColumns = `repeat(${gridConfig.cols}, 1fr)`;
            }

            if (layout === 'rows') {
                // åˆ†å±‚å¸ƒå±€
                products.forEach(rowData => {
                    const rowDiv = document.createElement('div');
                    rowDiv.className = 'shelf-row';
                    rowData.items.forEach(productId => {
                        rowDiv.appendChild(createProductItem(productId, showProductName));
                    });
                    container.appendChild(rowDiv);
                });
            } else {
                // å…¶ä»–å¸ƒå±€ï¼ˆvertical, grid, scattered, mixedï¼‰
                products.forEach(productId => {
                    container.appendChild(createProductItem(productId, showProductName));
                });
            }
        }

        /**
         * åˆ›å»ºå•†å“å…ƒç´ ï¼ˆæ¯ä¸ªå®ä¾‹æœ‰å”¯ä¸€IDï¼‰
         */
        function createProductItem(productId, showProductName = false) {
            const product = PRODUCTS[productId];
            const itemId = `item_${gameState.itemIdCounter++}`;
            const div = document.createElement('div');
            div.className = 'product-item';
            div.dataset.productId = productId;
            div.dataset.itemId = itemId;
            div.onclick = () => pickItem(itemId, productId);

            // è·å– emoji å°ºå¯¸ç±»
            const sizeClass = product.emojiSize ? `emoji-${product.emojiSize}` : '';

            // æ ¹æ® showProductName é…ç½®å†³å®šæ˜¯å¦æ˜¾ç¤ºå•†å“åç§°
            if (showProductName) {
                div.innerHTML = `
                    <div class="product-emoji ${sizeClass}">${product.emoji}</div>
                    <div class="product-name">${product.name}</div>
                `;
            } else {
                div.innerHTML = `
                    <div class="product-emoji ${sizeClass}">${product.emoji}</div>
                `;
            }

            return div;
        }

        /**
         * ==================== æ¸¸æˆæµç¨‹ ====================
         */

        /**
         * è®¡ç®—è®¢å•æ€»ä»·ï¼ˆåº”ç”¨æŠ˜æ‰£è§„åˆ™ï¼‰
         */
        function calculateOrderTotal(order) {
            let totalPrice = 0;

            order.forEach(item => {
                const productId = item.productId;
                const quantity = item.quantity;
                const unitPrice = PRODUCTS[productId].price;

                // æŸ¥æ‰¾é€‚ç”¨çš„æŠ˜æ‰£è§„åˆ™
                const discountRule = DISCOUNT_RULES.find(
                    rule => rule.productId === productId && rule.quantity <= quantity
                );

                if (discountRule) {
                    // æœ‰æŠ˜æ‰£ï¼šè®¡ç®—æœ‰å¤šå°‘å¥—æŠ˜æ‰£å•†å“
                    const discountSets = Math.floor(quantity / discountRule.quantity);
                    const remainder = quantity % discountRule.quantity;

                    // æŠ˜æ‰£ä»·æ ¼ Ã— å¥—æ•° + å•ä»· Ã— å‰©ä½™æ•°é‡
                    totalPrice += discountRule.price * discountSets;
                    totalPrice += unitPrice * remainder;
                } else {
                    // æ— æŠ˜æ‰£ï¼šç›´æ¥æŒ‰å•ä»·è®¡ç®—
                    totalPrice += unitPrice * quantity;
                }
            });

            return parseFloat(totalPrice.toFixed(2));
        }

        /**
         * ç”Ÿæˆéšæœºé¡¾å®¢è®¢å•
         */
        function generateCustomer() {
            // ç»Ÿè®¡è´§æ¶ä¸Šæ¯ç§å•†å“çš„æ•°é‡
            const productCounts = {};
            SHELF_CONFIG.forEach(config => {
                if (config.layout === 'rows') {
                    config.products.forEach(rowData => {
                        rowData.items.forEach(productId => {
                            productCounts[productId] = (productCounts[productId] || 0) + 1;
                        });
                    });
                } else {
                    config.products.forEach(productId => {
                        productCounts[productId] = (productCounts[productId] || 0) + 1;
                    });
                }
            });

            const availableProducts = Object.keys(productCounts);
            const numItems = 2 + Math.floor(Math.random() * 2); // 2-3ç§å•†å“
            const order = [];

            // éšæœºé€‰æ‹©å•†å“
            const selectedProducts = [];
            for (let i = 0; i < numItems && i < availableProducts.length; i++) {
                let productId;
                do {
                    productId = availableProducts[Math.floor(Math.random() * availableProducts.length)];
                } while (selectedProducts.includes(productId));
                selectedProducts.push(productId);

                // æ•°é‡ä¸è¶…è¿‡è´§æ¶ä¸Šè¯¥å•†å“çš„æ•°é‡
                const maxQuantity = Math.min(productCounts[productId], 3);
                const quantity = 1 + Math.floor(Math.random() * maxQuantity);
                order.push({ productId, quantity });
            }

            // è®¡ç®—æ€»ä»·ï¼ˆåº”ç”¨æŠ˜æ‰£ï¼‰
            const totalPrice = calculateOrderTotal(order);

            // ç”Ÿæˆæ”¯ä»˜é‡‘é¢ï¼ˆæ€»ä»· + éšæœº 2-10 ç¾å…ƒï¼Œç¡®ä¿éœ€è¦æ‰¾é›¶ï¼‰
            const extra = 2 + Math.floor(Math.random() * 9);
            const paid = parseFloat((totalPrice + extra).toFixed(2));
            const correctChange = parseFloat((paid - totalPrice).toFixed(2));

            // éšæœºé€‰æ‹©é¡¾å®¢å¤´åƒï¼ˆ1-4ï¼‰
            const avatarIndex = 1 + Math.floor(Math.random() * 4);
            const avatarImage = `chars/char${avatarIndex}.jpg`;

            return {
                order,
                bag: [],
                totalPrice,
                paid,
                correctChange,
                avatar: avatarImage
            };
        }

        /**
         * å¼€å§‹æ¥å•
         */
        function startOrder() {
            gameState.phase = 'order_received';
            gameState.currentCustomer = generateCustomer();
            gameState.selectedCoins = {};
            gameState.selectedAmount = 0;

            // é‡æ–°æ¸²æŸ“è´§æ¶ï¼ˆé‡ç½®æ‰€æœ‰å•†å“çŠ¶æ€ï¼‰
            initShelfAreas();

            // è®¾ç½®é¡¾å®¢å¤´åƒ
            const customerImage = document.getElementById('customerImage');
            customerImage.src = gameState.currentCustomer.avatar;

            // æ›´æ–°é¡¾å®¢åŒºåŸŸUI
            const order = gameState.currentCustomer.order;
            const orderHTML = order.map(item => {
                const product = PRODUCTS[item.productId];
                const sizeClass = product.emojiSize ? `emoji-${product.emojiSize}` : '';

                // æ‰€æœ‰å•†å“ç»Ÿä¸€æ˜¾ç¤ºï¼šemoji + æ•°é‡ï¼ˆä¸æ˜¾ç¤ºABCå­—æ¯ï¼‰
                return `<span class="${sizeClass}">${product.emoji}</span> x${item.quantity}`;
            }).join('  ');

            document.getElementById('dialogText').textContent = 'I want to buy:';
            document.getElementById('customerOrder').innerHTML = orderHTML;
            document.getElementById('bagItems').textContent = '-';
            document.getElementById('paymentInfo').classList.add('hidden');
            document.getElementById('cashierArea').classList.add('hidden');

            // è¿›å…¥æ‹¿è´§é˜¶æ®µ
            gameState.phase = 'picking_items';
        }

        /**
         * æ‹¿å•†å“ç»™é¡¾å®¢ï¼ˆæ¯ä¸ªå•†å“å®ä¾‹åªèƒ½ç‚¹ä¸€æ¬¡ï¼‰
         */
        function pickItem(itemId, productId) {
            if (gameState.phase !== 'picking_items') return;

            const order = gameState.currentCustomer.order;
            const bag = gameState.currentCustomer.bag;

            // è·å–è¯¥å•†å“å…ƒç´ 
            const itemEl = document.querySelector(`[data-item-id="${itemId}"]`);
            if (!itemEl || itemEl.classList.contains('picked')) {
                return; // å·²ç»è¢«é€‰è¿‡äº†
            }

            // æ£€æŸ¥æ˜¯å¦åœ¨è®¢å•ä¸­
            const orderItem = order.find(item => item.productId === productId);
            if (!orderItem) {
                // ä¸åœ¨è®¢å•ä¸­
                showTempMessage('Customer didn\'t order this!');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦å·²ç»æ‹¿å¤Ÿäº†
            const bagCount = bag.filter(id => id === productId).length;
            if (bagCount >= orderItem.quantity) {
                showTempMessage('Already enough of this item!');
                return;
            }

            // æ ‡è®°ä¸ºå·²é€‰
            itemEl.classList.add('picked');

            // æ·»åŠ åˆ°è´­ç‰©è¢‹
            bag.push(productId);
            updateCustomerBag();

            // æ£€æŸ¥æ˜¯å¦å®Œæˆè®¢å•
            checkOrderComplete();
        }

        /**
         * æ›´æ–°é¡¾å®¢è´­ç‰©è¢‹æ˜¾ç¤º
         */
        function updateCustomerBag() {
            const bag = gameState.currentCustomer.bag;
            const bagEl = document.getElementById('bagItems');
            const bagContainer = document.querySelector('.customer-bag');

            if (bag.length === 0) {
                bagEl.textContent = '-';
            } else {
                // ä½¿ç”¨ HTML æ¥æ˜¾ç¤ºä¸åŒå°ºå¯¸çš„ emoji
                const bagHTML = bag.map(id => {
                    const product = PRODUCTS[id];
                    const sizeClass = product.emojiSize ? `emoji-${product.emojiSize}` : '';
                    return `<span class="${sizeClass}">${product.emoji}</span>`;
                }).join(' ');
                bagEl.innerHTML = bagHTML;

                // Trigger shake animation
                if (bagContainer) {
                    bagContainer.classList.remove('shake');
                    // Force reflow to restart animation
                    void bagContainer.offsetWidth;
                    bagContainer.classList.add('shake');

                    // Remove shake class after animation completes
                    setTimeout(() => {
                        bagContainer.classList.remove('shake');
                    }, 500);
                }
            }
        }

        /**
         * æ£€æŸ¥æ˜¯å¦å‡‘é½è®¢å•
         */
        function checkOrderComplete() {
            const order = gameState.currentCustomer.order;
            const bag = gameState.currentCustomer.bag;

            // æ£€æŸ¥æ¯ä¸ªå•†å“æ•°é‡æ˜¯å¦åŒ¹é…
            const isComplete = order.every(item => {
                const bagCount = bag.filter(id => id === item.productId).length;
                return bagCount === item.quantity;
            });

            if (isComplete) {
                setTimeout(() => startMakingChange(), 500);
            }
        }

        /**
         * è¿›å…¥æ‰¾é›¶é˜¶æ®µ
         */
        function startMakingChange() {
            gameState.phase = 'making_change';

            // æ˜¾ç¤ºæ”¯ä»˜ä¿¡æ¯
            const customer = gameState.currentCustomer;
            document.getElementById('dialogText').textContent = 'Great! Here\'s the money:';
            document.getElementById('customerOrder').textContent = '';
            document.getElementById('paymentInfo').classList.remove('hidden');
            document.getElementById('paymentAmount').textContent = `Customer gave $${customer.paid.toFixed(2)}`;

            // æ˜¾ç¤ºæ”¶é“¶å°
            document.getElementById('cashierArea').classList.remove('hidden');
        }

        /**
         * æœåŠ¡ä¸‹ä¸€ä½é¡¾å®¢
         */
        function nextCustomer() {
            document.getElementById('feedbackOverlay').classList.remove('show');
            startOrder();
        }

        /**
         * ==================== è¾…åŠ©å‡½æ•° ====================
         */

        /**
         * æ˜¾ç¤ºä¸´æ—¶æç¤ºæ¶ˆæ¯
         */
        function showTempMessage(message) {
            const dialogText = document.getElementById('dialogText');
            const originalText = dialogText.textContent;
            dialogText.textContent = message;
            dialogText.style.color = '#d32f2f';

            setTimeout(() => {
                dialogText.textContent = originalText;
                dialogText.style.color = '#333';
            }, 1500);
        }

        /**
         * ==================== æ¸¸æˆåˆå§‹åŒ– ====================
         */
        window.addEventListener('DOMContentLoaded', async function() {
            // åŠ è½½é…ç½®æ–‡ä»¶
            await loadConfig();

            // åˆå§‹åŒ–è´§æ¶
            initShelfAreas();

            // æ˜¾ç¤ºè®¡ç®—å™¨
            document.getElementById('cashierArea').classList.remove('hidden');

            // åˆå§‹åŒ–ç­‰å¼è®°å½•å™¨æ˜¾ç¤º
            updateEquationDisplay();

            // å¼€å§‹ç¬¬ä¸€è½®
            startOrder();
        });
    </script>
</body>
</html>
